# 安全架构设计

## 🎯 核心知识点

- 认证与授权机制
- 数据安全保护
- 网络安全架构
- 安全威胁防护
- 合规性要求

## 📊 安全架构整体设计

```mermaid
graph TB
    A[用户] --> B[安全网关]
    
    subgraph "安全防护层"
        B --> C[WAF防火墙]
        C --> D[DDoS防护]
        D --> E[入侵检测]
        E --> F[认证授权]
    end
    
    subgraph "应用安全层"
        F --> G[API安全]
        G --> H[数据验证]
        H --> I[业务逻辑]
    end
    
    subgraph "数据安全层"
        I --> J[数据加密]
        J --> K[访问控制]
        K --> L[审计日志]
    end
    
    subgraph "基础设施安全"
        M[网络隔离]
        N[主机安全]
        O[容器安全]
        P[密钥管理]
    end
```

## 💡 面试题目

### **初级** 认证与授权设计
**题目：** 设计一个企业应用的用户认证和权限管理系统，支持多种登录方式和细粒度权限控制。

**答案要点：**

```mermaid
graph TD
    A[认证授权系统] --> B[认证Authentication]
    A --> C[授权Authorization]
    A --> D[会话管理]
    
    B --> B1[用户名密码]
    B --> B2[多因子认证]
    B --> B3[单点登录SSO]
    B --> B4[社交登录]
    
    C --> C1[RBAC角色控制]
    C --> C2[ABAC属性控制]
    C --> C3[ACL访问列表]
    
    D --> D1[Session管理]
    D --> D2[Token管理]
    D --> D3[会话超时]
```

**认证方式对比：**

| 认证方式 | 安全级别 | 用户体验 | 实现复杂度 | 适用场景 |
|----------|----------|----------|------------|----------|
| 用户名密码 | 中等 | 简单 | 低 | 基础应用 |
| 短信验证码 | 中等 | 一般 | 中等 | 移动应用 |
| 多因子认证 | 高 | 复杂 | 高 | 敏感系统 |
| 生物识别 | 高 | 便捷 | 高 | 移动设备 |
| 硬件Token | 很高 | 复杂 | 高 | 企业系统 |

### **中级** 数据安全保护策略
**题目：** 设计一个处理敏感数据的系统，需要考虑数据的加密、脱敏、备份和合规要求。

**答案要点：**

```mermaid
graph TB
    A[数据安全] --> B[传输加密]
    A --> C[存储加密]
    A --> D[数据脱敏]
    A --> E[访问控制]
    A --> F[数据备份]
    
    B --> B1[TLS/SSL]
    B --> B2[VPN隧道]
    B --> B3[端到端加密]
    
    C --> C1[磁盘加密]
    C --> C2[数据库加密]
    C --> C3[文件加密]
    
    D --> D1[静态脱敏]
    D --> D2[动态脱敏]
    D --> D3[格式保留]
    
    E --> E1[最小权限原则]
    E --> E2[数据分级]
    E --> E3[审计追踪]
    
    F --> F1[加密备份]
    F --> F2[异地备份]
    F --> F3[恢复测试]
```

**数据分级保护策略：**

```mermaid
flowchart TD
    A[数据分级] --> B[公开数据]
    A --> C[内部数据]
    A --> D[敏感数据]
    A --> E[机密数据]
    
    B --> B1[无特殊保护]
    B --> B2[基础访问控制]
    
    C --> C1[身份认证]
    C --> C2[访问日志]
    
    D --> D1[加密存储]
    D --> D2[脱敏处理]
    D --> D3[审批访问]
    
    E --> E1[强加密]
    E --> E2[多重认证]
    E --> E3[严格审计]
```

### **高级** 零信任安全架构
**题目：** 设计一个基于零信任原则的企业安全架构，实现"永不信任，始终验证"。

```mermaid
graph TB
    subgraph "零信任架构"
        A[用户/设备] --> B[身份验证]
        B --> C[设备信任评估]
        C --> D[风险评估引擎]
        D --> E[策略决策点]
        E --> F[微分段网络]
        F --> G[应用和数据]
    end
    
    subgraph "持续验证"
        H[行为分析]
        I[设备状态监控]
        J[网络流量分析]
        K[应用访问监控]
    end
    
    H --> D
    I --> D
    J --> D
    K --> D
```

## 🛡️ 安全威胁防护

### 常见Web安全威胁

```mermaid
graph TD
    A[Web安全威胁] --> B[注入攻击]
    A --> C[跨站攻击]
    A --> D[认证缺陷]
    A --> E[敏感数据泄露]
    A --> F[访问控制缺陷]
    
    B --> B1[SQL注入]
    B --> B2[NoSQL注入]
    B --> B3[命令注入]
    
    C --> C1[XSS跨站脚本]
    C --> C2[CSRF跨站请求]
    C --> C3[点击劫持]
    
    D --> D1[弱密码策略]
    D --> D2[会话管理缺陷]
    D --> D3[多因子认证绕过]
    
    E --> E1[传输未加密]
    E --> E2[存储未加密]
    E --> E3[日志敏感信息]
    
    F --> F1[水平权限提升]
    F --> F2[垂直权限提升]
    F --> F3[直接对象引用]
```

### OWASP Top 10防护措施

| 威胁 | 防护措施 | 技术实现 |
|------|----------|----------|
| 注入攻击 | 参数化查询、输入验证 | ORM框架、WAF |
| 认证缺陷 | 强密码策略、MFA | OAuth、JWT |
| 敏感数据泄露 | 加密传输和存储 | TLS、数据库加密 |
| XXE攻击 | 禁用外部实体解析 | XML解析器配置 |
| 访问控制缺陷 | 最小权限原则 | RBAC、API权限检查 |
| 安全配置错误 | 安全基线、定期扫描 | 配置管理、漏洞扫描 |
| XSS攻击 | 输出编码、CSP | 内容安全策略 |
| 不安全反序列化 | 输入验证、签名检查 | 安全序列化库 |
| 已知漏洞组件 | 依赖管理、定期更新 | 漏洞扫描工具 |
| 日志监控不足 | 完整日志、实时监控 | SIEM系统 |

## 🔧 技术实现

### JWT Token安全设计

```mermaid
sequenceDiagram
    participant Client
    participant AuthServer
    participant ResourceServer
    participant RefreshService
    
    Client->>AuthServer: 登录请求
    AuthServer->>AuthServer: 验证凭据
    AuthServer->>Client: 返回Access Token + Refresh Token
    
    Client->>ResourceServer: API请求 + Access Token
    ResourceServer->>ResourceServer: 验证Token
    ResourceServer->>Client: 返回资源
    
    Note over Client: Access Token过期
    Client->>RefreshService: Refresh Token
    RefreshService->>RefreshService: 验证Refresh Token
    RefreshService->>Client: 新的Access Token
```

**JWT安全最佳实践：**
- 使用强加密算法（RS256而非HS256）
- 设置合理的过期时间（Access Token短期，Refresh Token长期）
- 实现Token刷新机制
- 存储在HttpOnly Cookie中
- 添加防重放攻击机制

### API安全网关设计

```mermaid
graph LR
    A[客户端] --> B[API网关]
    
    subgraph "安全检查层"
        B --> C[速率限制]
        C --> D[身份验证]
        D --> E[权限检查]
        E --> F[输入验证]
    end
    
    subgraph "威胁防护"
        F --> G[SQL注入防护]
        G --> H[XSS过滤]
        H --> I[CSRF防护]
    end
    
    I --> J[后端服务]
```

## 📈 监控与检测

### 安全监控体系

```mermaid
graph TD
    A[安全监控] --> B[实时监控]
    A --> C[行为分析]
    A --> D[威胁情报]
    A --> E[事件响应]
    
    B --> B1[网络流量监控]
    B --> B2[系统日志分析]
    B --> B3[应用安全监控]
    
    C --> C1[用户行为分析]
    C --> C2[异常检测]
    C --> C3[风险评分]
    
    D --> D1[漏洞情报]
    D --> D2[攻击模式]
    D --> D3[IOC指标]
    
    E --> E1[自动响应]
    E --> E2[人工处置]
    E --> E3[事后分析]
```

### 安全事件处理流程

```mermaid
stateDiagram-v2
    [*] --> 检测
    检测 --> 分析: 发现异常
    分析 --> 确认: 初步分析
    确认 --> 响应: 确认威胁
    响应 --> 恢复: 处置完成
    恢复 --> 总结: 系统恢复
    总结 --> [*]: 完成处理
    
    分析 --> 检测: 误报
    确认 --> 检测: 非威胁
```

## 🔒 合规性要求

### 主要安全合规标准

| 标准 | 适用行业 | 主要要求 |
|------|----------|----------|
| GDPR | 欧盟数据处理 | 数据保护、用户权利 |
| SOX | 上市公司 | 财务数据完整性 |
| HIPAA | 医疗行业 | 健康信息保护 |
| PCI DSS | 支付行业 | 信用卡数据安全 |
| ISO 27001 | 通用 | 信息安全管理 |

### 数据隐私保护

```mermaid
flowchart TD
    A[数据隐私保护] --> B[数据最小化]
    A --> C[用户同意]
    A --> D[数据权利]
    A --> E[跨境传输]
    
    B --> B1[只收集必要数据]
    B --> B2[定期清理过期数据]
    
    C --> C1[明确同意机制]
    C --> C2[同意记录管理]
    
    D --> D1[查看权]
    D --> D2[修改权]
    D --> D3[删除权]
    D --> D4[数据可携带权]
    
    E --> E1[充分性认定]
    E --> E2[标准合同条款]
    E --> E3[约束性公司规则]
```

## 💡 面试要点总结

### 安全设计原则
1. **纵深防御**：多层安全控制，单点失效不会导致整体失效
2. **最小权限**：用户和系统只获得完成任务所需的最小权限
3. **默认安全**：系统默认配置应该是安全的
4. **安全透明**：安全机制对用户应该是透明的

### 威胁建模
1. **识别资产**：确定需要保护的数据和系统
2. **识别威胁**：分析可能的攻击向量
3. **评估风险**：计算威胁的影响和可能性
4. **确定对策**：选择合适的安全控制措施

### 安全测试
- **静态代码分析**：发现代码中的安全漏洞
- **动态安全测试**：运行时安全漏洞检测
- **渗透测试**：模拟真实攻击场景
- **安全审计**：定期检查安全配置和策略

### 常见误区
❌ **安全是事后考虑**：应该在设计阶段就考虑安全
❌ **依赖单一防护**：需要多层防护机制
❌ **忽视内部威胁**：内部用户也可能是威胁源
❌ **静态安全策略**：安全策略需要持续更新

## 🔗 相关链接

- [← 返回系统设计主页](./README.md)
- [API设计](./api-design.md)
- [微服务架构](./microservices-architecture.md)
- [监控与可观测性](./monitoring-observability.md)

---

*安全是系统设计的基础要求，需要在架构设计的每个层面都考虑安全因素* 🔐 