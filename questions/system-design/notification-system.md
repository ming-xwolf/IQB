# 通知系统设计

## 🎯 核心知识点

- 多渠道通知架构
- 消息可靠性保证
- 推送策略与个性化
- 大规模推送优化
- 通知去重与合并

## 📊 通知系统架构设计

```mermaid
graph TB
    A[业务应用] --> B[通知网关]
    
    subgraph "消息处理层"
        B --> C[消息路由]
        C --> D[消息队列]
        D --> E[消息处理器]
    end
    
    subgraph "渠道适配层"
        E --> F[短信网关]
        E --> G[邮件服务]
        E --> H[推送服务]
        E --> I[站内信]
        E --> J[微信/钉钉]
    end
    
    subgraph "存储层"
        K[用户偏好]
        L[消息模板]
        M[发送记录]
        N[失败重试]
    end
    
    F --> O[用户终端]
    G --> O
    H --> O
    I --> O
    J --> O
```

## 💡 面试题目

### **初级** 多渠道通知设计
**题目：** 设计一个支持短信、邮件、推送的多渠道通知系统，确保消息能够可靠送达。

**答案要点：**

```mermaid
graph TD
    A[通知请求] --> B[消息验证]
    B --> C[用户偏好查询]
    C --> D[渠道选择策略]
    
    D --> E[短信通道]
    D --> F[邮件通道]
    D --> G[推送通道]
    
    E --> H[短信服务商]
    F --> I[邮件服务器]
    G --> J[推送平台]
    
    H --> K[发送结果回调]
    I --> K
    J --> K
    
    K --> L[重试处理]
    L --> M[状态更新]
```

**渠道选择策略：**

| 场景 | 优先渠道 | 备用渠道 | 选择原因 |
|------|----------|----------|----------|
| 紧急通知 | 短信 | 推送+邮件 | 到达率高，即时性好 |
| 营销活动 | 推送 | 邮件 | 成本低，可交互 |
| 账户安全 | 短信+邮件 | 推送 | 双重确认，可信度高 |
| 系统公告 | 站内信 | 推送+邮件 | 持久化保存 |
| 订单状态 | 推送 | 短信 | 实时更新，成本平衡 |

### **中级** 大规模推送系统
**题目：** 设计一个支持千万级用户的推送系统，需要考虑推送速度、成功率和用户体验。

**答案要点：**

```mermaid
graph TB
    A[推送任务] --> B[任务分解]
    
    subgraph "分片处理"
        B --> C[用户分片1]
        B --> D[用户分片2]
        B --> E[用户分片N]
    end
    
    subgraph "推送引擎"
        C --> F[推送Worker1]
        D --> G[推送Worker2]
        E --> H[推送WorkerN]
    end
    
    subgraph "速率控制"
        F --> I[限流器]
        G --> I
        H --> I
    end
    
    I --> J[第三方推送平台]
    J --> K[用户设备]
    
    subgraph "监控反馈"
        L[送达统计]
        M[失败重试]
        N[用户反馈]
    end
    
    K --> L
    J --> M
    K --> N
```

### **高级** 智能推送策略
**题目：** 设计一个智能推送系统，根据用户行为和偏好进行个性化推送，提高用户参与度。

```mermaid
graph TB
    A[用户行为数据] --> B[用户画像]
    C[内容库] --> D[内容分析]
    
    subgraph "智能推荐引擎"
        B --> E[兴趣模型]
        D --> F[内容特征]
        E --> G[个性化匹配]
        F --> G
    end
    
    G --> H[推送决策]
    
    subgraph "时机优化"
        H --> I[最佳推送时间]
        H --> J[推送频率控制]
        H --> K[渠道选择]
    end
    
    I --> L[推送执行]
    J --> L
    K --> L
    
    L --> M[效果监控]
    M --> N[模型优化]
    N --> E
```

## 📱 推送渠道实现

### App推送架构

```mermaid
sequenceDiagram
    participant App as 客户端App
    participant Gateway as 推送网关
    participant Provider as 推送服务商
    participant Server as 业务服务器
    
    App->>Provider: 注册获取Token
    Provider->>App: 返回推送Token
    App->>Server: 上报Token和设备信息
    
    Server->>Gateway: 发送推送请求
    Gateway->>Provider: 调用推送接口
    Provider->>App: 推送消息到设备
    
    App->>Server: 推送送达回执
    Provider->>Gateway: 推送结果回调
    Gateway->>Server: 更新推送状态
```

### 推送服务商对比

| 服务商 | 覆盖平台 | 送达率 | 延迟 | 成本 | 特点 |
|--------|----------|--------|------|------|------|
| APNs | iOS | 95%+ | 低 | 免费 | 苹果官方，稳定性好 |
| FCM | Android | 90%+ | 低 | 免费 | Google官方，国外稳定 |
| 华为推送 | Android | 95%+ | 低 | 免费 | 华为设备优势明显 |
| 小米推送 | Android | 90%+ | 低 | 免费 | 小米设备专用 |
| 极光推送 | 全平台 | 85%+ | 中等 | 付费 | 第三方，集成简单 |
| 友盟推送 | 全平台 | 85%+ | 中等 | 付费 | 阿里系，功能丰富 |

### 推送消息格式

```json
{
  "notification": {
    "title": "订单状态更新",
    "body": "您的订单已发货，预计明天送达",
    "icon": "order_icon",
    "sound": "default",
    "badge": 1,
    "click_action": "ORDER_DETAIL"
  },
  "data": {
    "order_id": "12345",
    "status": "shipped",
    "tracking_number": "SF1234567890",
    "extra_data": "{\"promotion_id\": \"promo_001\"}"
  },
  "android": {
    "priority": "high",
    "ttl": "3600s",
    "collapse_key": "order_update"
  },
  "apns": {
    "headers": {
      "apns-priority": "10",
      "apns-expiration": "1640995200"
    },
    "payload": {
      "aps": {
        "alert": {
          "title": "订单状态更新",
          "body": "您的订单已发货，预计明天送达"
        },
        "badge": 1,
        "sound": "default"
      }
    }
  }
}
```

## 📧 邮件通知系统

### 邮件发送架构

```mermaid
graph TD
    A[邮件请求] --> B[邮件队列]
    B --> C[邮件处理器]
    
    C --> D[模板渲染]
    D --> E[收件人验证]
    E --> F[邮件组装]
    
    F --> G{发送策略}
    G -->|直接发送| H[SMTP服务器]
    G -->|第三方服务| I[邮件服务商]
    
    H --> J[目标邮箱]
    I --> J
    
    J --> K[发送结果]
    K --> L[状态更新]
    L --> M[重试/失败处理]
```

### 邮件模板系统

```mermaid
graph TD
    A[邮件模板] --> B[基础模板]
    A --> C[业务模板]
    
    B --> B1[HTML模板]
    B --> B2[样式定义]
    B --> B3[通用组件]
    
    C --> C1[欢迎邮件]
    C --> C2[订单确认]
    C --> C3[密码重置]
    C --> C4[营销邮件]
    
    D[变量替换] --> E[邮件渲染]
    E --> F[预览检查]
    F --> G[发送执行]
```

## 📲 短信通知系统

### 短信网关架构

```mermaid
graph TD
    A[短信请求] --> B[参数验证]
    B --> C[敏感词过滤]
    C --> D[运营商路由]
    
    D --> E[移动网关]
    D --> F[联通网关]
    D --> G[电信网关]
    
    E --> H[用户手机]
    F --> H
    G --> H
    
    H --> I[状态报告]
    I --> J[送达确认]
    J --> K[计费统计]
```

### 短信发送策略

```mermaid
flowchart TD
    A[短信发送请求] --> B{是否验证码?}
    
    B -->|是| C[验证码短信]
    B -->|否| D[营销/通知短信]
    
    C --> E[高优先级通道]
    D --> F[普通优先级通道]
    
    E --> G[专线通道]
    F --> H[共享通道]
    
    G --> I[运营商A]
    H --> J[运营商B]
    
    I --> K{发送成功?}
    J --> K
    
    K -->|是| L[更新状态]
    K -->|否| M[失败重试]
    
    M --> N{重试次数<3?}
    N -->|是| O[换通道重试]
    N -->|否| P[标记失败]
    
    O --> I
```

## 🎯 个性化推送策略

### 用户画像构建

```mermaid
graph TD
    A[用户数据] --> B[基础画像]
    A --> C[行为画像]
    A --> D[偏好画像]
    
    B --> B1[年龄]
    B --> B2[性别]
    B --> B3[地域]
    B --> B4[职业]
    
    C --> C1[活跃时间]
    C --> C2[使用频率]
    C --> C3[功能偏好]
    C --> C4[停留时长]
    
    D --> D1[内容偏好]
    D --> D2[渠道偏好]
    D --> D3[推送频率]
    D --> D4[互动习惯]
    
    B1 --> E[画像模型]
    C1 --> E
    D1 --> E
    
    E --> F[个性化推送]
```

### 推送时机优化

```mermaid
timeline
    title 用户活跃时间分析
    
    section 工作日
        06:00-09:00 : 早高峰<br/>通勤时间<br/>新闻资讯类推送
        12:00-14:00 : 午休时间<br/>娱乐内容推送
        18:00-22:00 : 晚高峰<br/>购物/生活类推送
    
    section 周末
        09:00-11:00 : 休闲时光<br/>娱乐/购物推送
        14:00-17:00 : 下午茶时间<br/>社交/分享类推送
        19:00-23:00 : 黄金时间<br/>全类型推送
```

## 🔧 消息可靠性保证

### 消息状态流转

```mermaid
stateDiagram-v2
    [*] --> 待发送
    待发送 --> 发送中: 开始发送
    发送中 --> 发送成功: 送达确认
    发送中 --> 发送失败: 发送失败
    发送失败 --> 等待重试: 可重试错误
    发送失败 --> 失败终止: 不可重试错误
    等待重试 --> 发送中: 重试执行
    等待重试 --> 失败终止: 超过重试次数
    发送成功 --> [*]
    失败终止 --> [*]
```

### 消息去重策略

```mermaid
graph TD
    A[消息请求] --> B[生成消息ID]
    B --> C[布隆过滤器]
    
    C --> D{可能重复?}
    D -->|否| E[直接处理]
    D -->|是| F[精确查重]
    
    F --> G{确认重复?}
    G -->|是| H[丢弃消息]
    G -->|否| I[正常处理]
    
    E --> J[消息处理]
    I --> J
    
    J --> K[记录消息ID]
    K --> L[定期清理]
```

### 重试机制设计

```mermaid
flowchart TD
    A[发送失败] --> B{错误类型判断}
    
    B -->|网络错误| C[立即重试]
    B -->|限流错误| D[延迟重试]
    B -->|系统错误| E[指数退避重试]
    B -->|业务错误| F[人工处理]
    
    C --> G{重试次数<3?}
    D --> H{重试次数<5?}
    E --> I{重试次数<10?}
    
    G -->|是| J[1分钟后重试]
    H -->|是| K[5分钟后重试]
    I -->|是| L[指数时间重试]
    
    G -->|否| M[标记失败]
    H -->|否| M
    I -->|否| M
    
    J --> N[执行重试]
    K --> N
    L --> N
    
    N --> O{发送成功?}
    O -->|是| P[更新状态]
    O -->|否| B
```

## 📊 监控与分析

### 核心指标监控

```mermaid
graph TD
    A[推送监控] --> B[发送指标]
    A --> C[送达指标]
    A --> D[用户行为指标]
    A --> E[业务效果指标]
    
    B --> B1[发送量]
    B --> B2[发送速率]
    B --> B3[发送成功率]
    
    C --> C1[送达率]
    C --> C2[送达延迟]
    C --> C3[渠道送达率]
    
    D --> D1[点击率]
    D --> D2[转化率]
    D --> D3[取消订阅率]
    
    E --> E1[业务转化]
    E --> E2[用户留存]
    E --> E3[收入贡献]
```

### 实时监控仪表板

```mermaid
graph TD
    A[监控仪表板] --> B[实时大屏]
    A --> C[告警系统]
    A --> D[分析报表]
    
    B --> B1[发送量实时统计]
    B --> B2[送达率趋势图]
    B --> B3[渠道健康状态]
    
    C --> C1[发送失败告警]
    C --> C2[送达率下降告警]
    C --> C3[系统异常告警]
    
    D --> D1[日报/周报/月报]
    D --> D2[渠道效果分析]
    D --> D3[用户行为分析]
```

## 💡 面试要点总结

### 系统设计要点
1. **高可用性**：多渠道冗余，故障自动切换
2. **高并发**：消息队列异步处理，分片并行发送
3. **可靠性**：消息持久化，失败重试机制
4. **可扩展性**：微服务架构，水平扩展能力

### 渠道选择策略
- **实时性要求**：短信 > 推送 > 邮件 > 站内信
- **成本控制**：站内信 < 推送 < 邮件 < 短信
- **送达率**：短信 > 邮件 > 推送 > 站内信
- **富媒体支持**：邮件 > 推送 > 站内信 > 短信

### 个性化推送关键
- **用户画像**：基于用户行为和属性建立画像
- **内容推荐**：根据用户兴趣推荐相关内容
- **时机优化**：分析用户活跃时间，选择最佳推送时机
- **频率控制**：避免过度打扰，维护用户体验

### 技术挑战与解决方案

| 挑战 | 解决方案 | 技术选型 |
|------|----------|----------|
| 大规模推送 | 分片并行处理 | Kafka + 多Worker |
| 消息可靠性 | 持久化 + 重试 | Redis + MySQL |
| 送达率优化 | 多渠道 + 智能路由 | 负载均衡算法 |
| 个性化推荐 | 机器学习 + 实时计算 | Spark + 推荐算法 |

### 常见问题与对策
❌ **推送骚扰**：用户取消订阅率高
✅ **解决方案**：智能频率控制，内容个性化

❌ **送达率低**：消息无法及时送达用户
✅ **解决方案**：多渠道备份，运营商优选

❌ **系统过载**：推送高峰期系统性能下降
✅ **解决方案**：削峰填谷，弹性扩容

## 🔗 相关链接

- [← 返回系统设计主页](./README.md)
- [消息队列](./message-queues.md)
- [高并发处理](./high-concurrency.md)
- [用户推荐系统](./recommendation-system.md)

---

*通知系统是用户体验的重要组成部分，需要在及时性和用户体验之间找到平衡* 📢 