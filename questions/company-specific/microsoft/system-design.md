# å¾®è½¯ç³»ç»Ÿè®¾è®¡é¢è¯•é¢˜

## ğŸ“š é¢˜ç›®æ¦‚è§ˆ

å¾®è½¯ç³»ç»Ÿè®¾è®¡é¢è¯•é‡ç‚¹è€ƒå¯Ÿå€™é€‰äººè®¾è®¡å¤§è§„æ¨¡ã€é«˜å¯ç”¨ã€å¯æ‰©å±•ç³»ç»Ÿçš„èƒ½åŠ›ã€‚é¢˜ç›®é€šå¸¸æ¶‰åŠä¼ä¸šçº§åº”ç”¨åœºæ™¯ï¼Œå¦‚Office 365ã€Teamsã€AzureæœåŠ¡ç­‰çœŸå®ä¸šåŠ¡ç³»ç»Ÿçš„æ¶æ„è®¾è®¡æŒ‘æˆ˜ã€‚

## ğŸ¯ è®¾è®¡åŸåˆ™å’Œè€ƒå¯Ÿé‡ç‚¹

### æ ¸å¿ƒè®¾è®¡åŸåˆ™
- **å¯æ‰©å±•æ€§** - æ”¯æŒç™¾ä¸‡åˆ°äº¿çº§ç”¨æˆ·è§„æ¨¡
- **é«˜å¯ç”¨æ€§** - 99.9%ä»¥ä¸Šçš„æœåŠ¡å¯ç”¨æ€§
- **ä¸€è‡´æ€§** - æ•°æ®ä¸€è‡´æ€§å’Œä¸šåŠ¡é€»è¾‘ä¸€è‡´æ€§
- **æ€§èƒ½ä¼˜åŒ–** - ä½å»¶è¿Ÿå’Œé«˜ååé‡
- **å®‰å…¨æ€§** - ä¼ä¸šçº§å®‰å…¨å’Œåˆè§„è¦æ±‚

### å¾®è½¯æŠ€æœ¯æ ˆé‡ç‚¹
- **Azureäº‘æœåŠ¡** - å……åˆ†åˆ©ç”¨Azureå¹³å°èƒ½åŠ›
- **æ··åˆäº‘æ¶æ„** - äº‘ç«¯å’Œæœ¬åœ°çš„æ— ç¼é›†æˆ
- **ä¼ä¸šé›†æˆ** - ä¸ç°æœ‰ä¼ä¸šç³»ç»Ÿçš„äº’æ“ä½œ
- **å…¨çƒåŒ–æ”¯æŒ** - å¤šåŒºåŸŸéƒ¨ç½²å’Œæœ¬åœ°åŒ–

## ğŸ“ æ ¸å¿ƒè®¾è®¡é¢˜ç›®

### 1. å¤§è§„æ¨¡åä½œå¹³å°è®¾è®¡

#### é¢˜ç›®1ï¼šè®¾è®¡ç±»ä¼¼Microsoft Teamsçš„ä¼ä¸šåä½œå¹³å°
**é—®é¢˜**ï¼šè®¾è®¡ä¸€ä¸ªæ”¯æŒ1000ä¸‡ç”¨æˆ·çš„ä¼ä¸šåä½œå¹³å°ï¼ŒåŒ…æ‹¬å®æ—¶æ¶ˆæ¯ã€è§†é¢‘ä¼šè®®ã€æ–‡ä»¶å…±äº«å’Œåº”ç”¨é›†æˆåŠŸèƒ½ã€‚

**éœ€æ±‚åˆ†æ**ï¼š
```mermaid
mindmap
  root((Teamsæ¶æ„))
    ç”¨æˆ·è§„æ¨¡
      1000ä¸‡æ³¨å†Œç”¨æˆ·
      100ä¸‡å¹¶å‘ç”¨æˆ·
      10ä¸‡å¹¶å‘ä¼šè®®
    æ ¸å¿ƒåŠŸèƒ½
      å®æ—¶æ¶ˆæ¯
        æ–‡æœ¬æ¶ˆæ¯
        æ–‡ä»¶åˆ†äº«
        è¡¨æƒ…ååº”
        æ¶ˆæ¯æœç´¢
      è§†é¢‘ä¼šè®®
        å¤šæ–¹é€šè¯
        å±å¹•å…±äº«
        å½•åˆ¶å›æ”¾
        å®æ—¶å­—å¹•
      æ–‡ä»¶åä½œ
        åœ¨çº¿ç¼–è¾‘
        ç‰ˆæœ¬æ§åˆ¶
        è¯„è®ºæ‰¹æ³¨
        æƒé™ç®¡ç†
      åº”ç”¨é›†æˆ
        ç¬¬ä¸‰æ–¹åº”ç”¨
        Botæ¡†æ¶
        å·¥ä½œæµè‡ªåŠ¨åŒ–
    æŠ€æœ¯è¦æ±‚
      ä½å»¶è¿Ÿ
        æ¶ˆæ¯<100ms
        éŸ³è§†é¢‘<150ms
      é«˜å¯ç”¨
        99.99%å¯ç”¨æ€§
        æ•…éšœè‡ªåŠ¨æ¢å¤
      å®‰å…¨åˆè§„
        ç«¯åˆ°ç«¯åŠ å¯†
        ä¼ä¸šèº«ä»½é›†æˆ
        å®¡è®¡æ—¥å¿—
```

**æ¶æ„è®¾è®¡æ–¹æ¡ˆ**ï¼š
```mermaid
graph TB
    subgraph "å®¢æˆ·ç«¯å±‚"
        A[Webå®¢æˆ·ç«¯]
        B[æ¡Œé¢åº”ç”¨]
        C[ç§»åŠ¨åº”ç”¨]
    end
    
    subgraph "CDNå’Œè¾¹ç¼˜"
        D[Azure Front Door]
        E[Azure CDN]
        F[è¾¹ç¼˜èŠ‚ç‚¹]
    end
    
    subgraph "APIç½‘å…³å±‚"
        G[API Management]
        H[èº«ä»½è®¤è¯]
        I[é™æµæ§åˆ¶]
    end
    
    subgraph "å¾®æœåŠ¡å±‚"
        J[ç”¨æˆ·æœåŠ¡]
        K[æ¶ˆæ¯æœåŠ¡]
        L[ä¼šè®®æœåŠ¡]
        M[æ–‡ä»¶æœåŠ¡]
        N[é€šçŸ¥æœåŠ¡]
    end
    
    subgraph "å®æ—¶é€šä¿¡"
        O[SignalR Service]
        P[åª’ä½“å¤„ç†æœåŠ¡]
        Q[WebRTCç½‘å…³]
    end
    
    subgraph "æ•°æ®å±‚"
        R[Cosmos DB]
        S[Blob Storage]
        T[Azure SQL]
        U[Redis Cache]
    end
    
    subgraph "åŸºç¡€è®¾æ–½"
        V[Service Bus]
        W[Event Grid]
        X[Application Insights]
        Y[Key Vault]
    end
    
    A --> D
    B --> D
    C --> D
    D --> E
    D --> G
    G --> H
    G --> J
    G --> K
    G --> L
    G --> M
    K --> O
    L --> P
    L --> Q
    J --> R
    K --> R
    M --> S
    J --> T
    K --> U
    O --> V
    P --> W
```

**æ ¸å¿ƒæœåŠ¡è®¾è®¡**ï¼š

1. **æ¶ˆæ¯æœåŠ¡æ¶æ„**ï¼š
```csharp
// æ¶ˆæ¯æœåŠ¡æ ¸å¿ƒå®ç°
public class MessageService
{
    private readonly ICosmosRepository<Message> _messageRepository;
    private readonly ICacheService _cacheService;
    private readonly IEventBus _eventBus;
    private readonly ISignalRService _signalRService;
    
    public async Task<MessageResponse> SendMessageAsync(SendMessageRequest request)
    {
        // 1. æ¶ˆæ¯éªŒè¯å’Œé¢„å¤„ç†
        var message = new Message
        {
            Id = Guid.NewGuid().ToString(),
            ConversationId = request.ConversationId,
            SenderId = request.SenderId,
            Content = await ProcessMessageContent(request.Content),
            MessageType = request.MessageType,
            Timestamp = DateTime.UtcNow,
            Status = MessageStatus.Sent
        };
        
        // 2. æ¶ˆæ¯æŒä¹…åŒ–ï¼ˆåˆ†ç‰‡ç­–ç•¥ï¼‰
        await _messageRepository.CreateAsync(message, message.ConversationId);
        
        // 3. ç¼“å­˜æœ€æ–°æ¶ˆæ¯
        await _cacheService.AddToSortedSetAsync(
            $"conversation:{request.ConversationId}:messages",
            message,
            message.Timestamp.Ticks);
        
        // 4. å®æ—¶æ¨é€
        await _signalRService.SendToGroupAsync(
            request.ConversationId,
            "MessageReceived",
            message);
        
        // 5. å¼‚æ­¥äº‹ä»¶å¤„ç†
        await _eventBus.PublishAsync(new MessageSentEvent
        {
            MessageId = message.Id,
            ConversationId = request.ConversationId,
            SenderId = request.SenderId,
            Recipients = request.Recipients,
            Timestamp = message.Timestamp
        });
        
        return new MessageResponse
        {
            MessageId = message.Id,
            Success = true,
            Timestamp = message.Timestamp
        };
    }
    
    public async Task<ConversationHistory> GetConversationHistoryAsync(
        string conversationId,
        string continuationToken = null,
        int pageSize = 50)
    {
        // 1. å°è¯•ä»ç¼“å­˜è·å–
        var cachedMessages = await _cacheService.GetSortedSetRangeAsync<Message>(
            $"conversation:{conversationId}:messages",
            0, pageSize - 1);
        
        if (cachedMessages.Any())
        {
            return new ConversationHistory
            {
                Messages = cachedMessages,
                HasMore = cachedMessages.Count == pageSize
            };
        }
        
        // 2. ä»æ•°æ®åº“æŸ¥è¯¢
        var query = _messageRepository.Query()
            .Where(m => m.ConversationId == conversationId)
            .OrderByDescending(m => m.Timestamp);
        
        var result = await _messageRepository.GetPagedResultAsync(
            query, continuationToken, pageSize);
        
        // 3. é¢„åŠ è½½åˆ°ç¼“å­˜
        if (string.IsNullOrEmpty(continuationToken))
        {
            await PreloadMessagesToCache(conversationId, result.Items);
        }
        
        return new ConversationHistory
        {
            Messages = result.Items,
            ContinuationToken = result.ContinuationToken,
            HasMore = !string.IsNullOrEmpty(result.ContinuationToken)
        };
    }
}
```

2. **è§†é¢‘ä¼šè®®æœåŠ¡è®¾è®¡**ï¼š
```csharp
public class MeetingService
{
    private readonly IMediaServerPool _mediaServerPool;
    private readonly IMeetingRepository _meetingRepository;
    private readonly ISignalRService _signalRService;
    private readonly IRecordingService _recordingService;
    
    public async Task<JoinMeetingResponse> JoinMeetingAsync(JoinMeetingRequest request)
    {
        // 1. éªŒè¯ä¼šè®®æƒé™
        var meeting = await _meetingRepository.GetAsync(request.MeetingId);
        if (meeting == null || !await CanJoinMeeting(request.UserId, meeting))
        {
            throw new UnauthorizedAccessException("Cannot join meeting");
        }
        
        // 2. é€‰æ‹©æœ€ä¼˜åª’ä½“æœåŠ¡å™¨
        var mediaServer = await _mediaServerPool.GetOptimalServerAsync(
            request.UserLocation, meeting.Participants.Count);
        
        // 3. åˆ›å»ºåª’ä½“è¿æ¥
        var mediaConnection = await mediaServer.CreateConnectionAsync(new MediaConnectionRequest
        {
            MeetingId = request.MeetingId,
            UserId = request.UserId,
            AudioEnabled = request.AudioEnabled,
            VideoEnabled = request.VideoEnabled,
            ScreenShareEnabled = false
        });
        
        // 4. æ›´æ–°ä¼šè®®çŠ¶æ€
        meeting.Participants.Add(new MeetingParticipant
        {
            UserId = request.UserId,
            JoinedAt = DateTime.UtcNow,
            MediaServerId = mediaServer.Id,
            ConnectionId = mediaConnection.Id
        });
        
        await _meetingRepository.UpdateAsync(meeting);
        
        // 5. é€šçŸ¥å…¶ä»–å‚ä¸è€…
        await _signalRService.SendToGroupAsync(
            request.MeetingId,
            "ParticipantJoined",
            new ParticipantJoinedEvent
            {
                UserId = request.UserId,
                JoinedAt = DateTime.UtcNow
            });
        
        // 6. å¯åŠ¨å½•åˆ¶ï¼ˆå¦‚æœéœ€è¦ï¼‰
        if (meeting.RecordingEnabled && meeting.Participants.Count == 1)
        {
            await _recordingService.StartRecordingAsync(request.MeetingId);
        }
        
        return new JoinMeetingResponse
        {
            MediaServerEndpoint = mediaServer.Endpoint,
            ConnectionToken = mediaConnection.Token,
            IceServers = mediaServer.IceServers,
            MeetingInfo = MapToMeetingInfo(meeting)
        };
    }
    
    public async Task HandleMediaServerScaling()
    {
        var serverMetrics = await _mediaServerPool.GetAllServerMetricsAsync();
        
        foreach (var server in serverMetrics)
        {
            // CPUä½¿ç”¨ç‡è¶…è¿‡80%æ—¶æ‰©å®¹
            if (server.CpuUtilization > 0.8)
            {
                await _mediaServerPool.ScaleUpAsync(server.Id);
                
                // è¿ç§»éƒ¨åˆ†ä¼šè®®åˆ°æ–°æœåŠ¡å™¨
                var meetingsToMigrate = await GetMeetingsForMigration(server.Id);
                foreach (var meeting in meetingsToMigrate)
                {
                    await MigrateMeetingToNewServer(meeting);
                }
            }
            
            // CPUä½¿ç”¨ç‡ä½äº20%æ—¶ç¼©å®¹
            if (server.CpuUtilization < 0.2 && server.ActiveMeetings == 0)
            {
                await _mediaServerPool.ScaleDownAsync(server.Id);
            }
        }
    }
}
```

3. **æ–‡ä»¶åä½œæœåŠ¡**ï¼š
```csharp
public class FileCollaborationService
{
    private readonly IBlobStorageService _blobStorage;
    private readonly IDocumentRepository _documentRepository;
    private readonly ISignalRService _signalRService;
    private readonly IVersionControlService _versionControl;
    
    public async Task<DocumentSession> StartEditSessionAsync(StartEditRequest request)
    {
        // 1. è·å–æ–‡æ¡£å…ƒæ•°æ®
        var document = await _documentRepository.GetAsync(request.DocumentId);
        if (document == null)
        {
            throw new DocumentNotFoundException(request.DocumentId);
        }
        
        // 2. æ£€æŸ¥ç¼–è¾‘æƒé™
        if (!await HasEditPermission(request.UserId, document))
        {
            throw new InsufficientPermissionsException();
        }
        
        // 3. åˆ›å»ºåä½œä¼šè¯
        var session = new DocumentSession
        {
            Id = Guid.NewGuid().ToString(),
            DocumentId = request.DocumentId,
            UserId = request.UserId,
            StartTime = DateTime.UtcNow,
            LockToken = Guid.NewGuid().ToString()
        };
        
        // 4. åº”ç”¨åˆ†å¸ƒå¼é”
        var lockAcquired = await _versionControl.TryAcquireLockAsync(
            request.DocumentId, session.LockToken, TimeSpan.FromMinutes(30));
        
        if (!lockAcquired)
        {
            throw new DocumentLockedException("Document is being edited by another user");
        }
        
        // 5. è·å–æœ€æ–°æ–‡æ¡£å†…å®¹
        var content = await _blobStorage.GetDocumentContentAsync(
            document.BlobPath, document.Version);
        
        // 6. é€šçŸ¥å…¶ä»–åä½œè€…
        await _signalRService.SendToGroupAsync(
            $"document:{request.DocumentId}",
            "EditSessionStarted",
            new EditSessionStartedEvent
            {
                SessionId = session.Id,
                UserId = request.UserId,
                UserName = request.UserName,
                StartTime = session.StartTime
            });
        
        return new DocumentSession
        {
            SessionId = session.Id,
            Content = content,
            Version = document.Version,
            LockToken = session.LockToken,
            CollaborativeEditingEndpoint = GetCollaborativeEditingEndpoint(session.Id)
        };
    }
    
    public async Task<SaveResult> SaveDocumentAsync(SaveDocumentRequest request)
    {
        // 1. éªŒè¯ä¼šè¯å’Œé”
        var isValidSession = await _versionControl.ValidateLockAsync(
            request.DocumentId, request.LockToken);
        
        if (!isValidSession)
        {
            throw new InvalidSessionException("Invalid session or lock expired");
        }
        
        // 2. åˆ›å»ºæ–°ç‰ˆæœ¬
        var newVersion = await _versionControl.CreateVersionAsync(new CreateVersionRequest
        {
            DocumentId = request.DocumentId,
            Content = request.Content,
            UserId = request.UserId,
            ChangeDescription = request.ChangeDescription,
            PreviousVersion = request.BaseVersion
        });
        
        // 3. ä¿å­˜åˆ°Blobå­˜å‚¨
        var blobPath = $"documents/{request.DocumentId}/versions/{newVersion.Id}";
        await _blobStorage.SaveDocumentAsync(blobPath, request.Content);
        
        // 4. æ›´æ–°æ–‡æ¡£å…ƒæ•°æ®
        var document = await _documentRepository.GetAsync(request.DocumentId);
        document.Version = newVersion.Id;
        document.LastModifiedBy = request.UserId;
        document.LastModifiedAt = DateTime.UtcNow;
        document.BlobPath = blobPath;
        
        await _documentRepository.UpdateAsync(document);
        
        // 5. é‡Šæ”¾é”
        await _versionControl.ReleaseLockAsync(request.DocumentId, request.LockToken);
        
        // 6. é€šçŸ¥åä½œè€…
        await _signalRService.SendToGroupAsync(
            $"document:{request.DocumentId}",
            "DocumentSaved",
            new DocumentSavedEvent
            {
                DocumentId = request.DocumentId,
                NewVersion = newVersion.Id,
                SavedBy = request.UserId,
                SavedAt = DateTime.UtcNow
            });
        
        return new SaveResult
        {
            Success = true,
            NewVersion = newVersion.Id,
            SavedAt = DateTime.UtcNow
        };
    }
}
```

### 2. ä¼ä¸šçº§æœç´¢å¹³å°è®¾è®¡

#### é¢˜ç›®2ï¼šè®¾è®¡ç±»ä¼¼Microsoft Graphçš„ä¼ä¸šæ•°æ®æœç´¢å¹³å°
**é—®é¢˜**ï¼šè®¾è®¡ä¸€ä¸ªèƒ½å¤Ÿæœç´¢ä¼ä¸šå†…æ‰€æœ‰æ•°æ®æºï¼ˆé‚®ä»¶ã€æ–‡æ¡£ã€æ—¥å†ã€Teamsæ¶ˆæ¯ç­‰ï¼‰çš„ç»Ÿä¸€æœç´¢å¹³å°ï¼Œæ”¯æŒæ™ºèƒ½æœç´¢å’Œä¸ªæ€§åŒ–ç»“æœã€‚

**ç³»ç»Ÿæ¶æ„è®¾è®¡**ï¼š
```mermaid
graph TB
    subgraph "æ•°æ®æºå±‚"
        A[Exchange Online]
        B[SharePoint]
        C[OneDrive]
        D[Teams]
        E[Outlook]
        F[ç¬¬ä¸‰æ–¹ç³»ç»Ÿ]
    end
    
    subgraph "æ•°æ®æ¥å…¥å±‚"
        G[Graph Connectors]
        H[Change Tracking]
        I[æ•°æ®åŒæ­¥æœåŠ¡]
    end
    
    subgraph "æ•°æ®å¤„ç†å±‚"
        J[å†…å®¹æå–]
        K[NLPå¤„ç†]
        L[å®ä½“è¯†åˆ«]
        M[æƒé™æå–]
    end
    
    subgraph "æœç´¢å¼•æ“å±‚"
        N[Azure Cognitive Search]
        O[ç´¢å¼•æœåŠ¡]
        P[æ’åºç®—æ³•]
        Q[ä¸ªæ€§åŒ–å¼•æ“]
    end
    
    subgraph "APIå±‚"
        R[Microsoft Graph API]
        S[æœç´¢API]
        T[æƒé™éªŒè¯]
    end
    
    subgraph "åº”ç”¨å±‚"
        U[Office 365]
        V[Teams]
        W[Outlook]
        X[ç¬¬ä¸‰æ–¹åº”ç”¨]
    end
    
    A --> G
    B --> G
    C --> G
    D --> G
    E --> G
    F --> G
    
    G --> H
    H --> I
    I --> J
    J --> K
    K --> L
    L --> M
    
    M --> O
    O --> N
    N --> P
    P --> Q
    
    Q --> S
    S --> R
    R --> T
    
    T --> U
    T --> V
    T --> W
    T --> X
```

**æ ¸å¿ƒæœç´¢æœåŠ¡å®ç°**ï¼š
```csharp
public class EnterpriseSearchService
{
    private readonly ISearchIndexClient _searchClient;
    private readonly IPermissionService _permissionService;
    private readonly IPersonalizationEngine _personalizationEngine;
    private readonly ICacheService _cacheService;
    
    public async Task<SearchResults> SearchAsync(SearchRequest request)
    {
        // 1. æŸ¥è¯¢é¢„å¤„ç†å’Œæ„å›¾è¯†åˆ«
        var processedQuery = await PreprocessQuery(request.Query, request.UserId);
        
        // 2. æ„å»ºæœç´¢è¿‡æ»¤å™¨ï¼ˆåŸºäºæƒé™ï¼‰
        var permissionFilter = await BuildPermissionFilter(request.UserId);
        
        // 3. ä¸ªæ€§åŒ–æœç´¢å‚æ•°
        var personalizationParams = await _personalizationEngine.GetUserPreferencesAsync(request.UserId);
        
        // 4. æ‰§è¡Œæœç´¢
        var searchOptions = new SearchOptions
        {
            Filter = permissionFilter,
            OrderBy = BuildSortCriteria(personalizationParams),
            SearchFields = GetSearchFields(processedQuery.EntityTypes),
            IncludeTotalCount = true,
            Skip = request.Skip,
            Size = Math.Min(request.Size, 100) // é™åˆ¶æœ€å¤§è¿”å›æ•°é‡
        };
        
        // æ·»åŠ æ™ºèƒ½æœç´¢å¢å¼º
        if (processedQuery.HasDateFilter)
        {
            searchOptions.Filter += $" and lastModified ge {processedQuery.DateFilter:yyyy-MM-ddTHH:mm:ssZ}";
        }
        
        if (processedQuery.HasFileTypeFilter)
        {
            searchOptions.Filter += $" and fileType eq '{processedQuery.FileType}'";
        }
        
        var searchResponse = await _searchClient.SearchAsync<SearchDocument>(
            processedQuery.EnhancedQuery, searchOptions);
        
        // 5. ç»“æœåå¤„ç†å’Œä¸ªæ€§åŒ–æ’åº
        var results = await ProcessSearchResults(searchResponse.Value, request.UserId, personalizationParams);
        
        // 6. è®°å½•æœç´¢è¡Œä¸ºç”¨äºå­¦ä¹ 
        await RecordSearchBehavior(request, results);
        
        return new SearchResults
        {
            Items = results,
            TotalCount = searchResponse.Value.TotalCount,
            QueryId = Guid.NewGuid().ToString(),
            ProcessingTime = searchResponse.Value.SearchTime,
            Suggestions = await GenerateSearchSuggestions(request.Query, request.UserId)
        };
    }
    
    private async Task<ProcessedQuery> PreprocessQuery(string query, string userId)
    {
        var processed = new ProcessedQuery { OriginalQuery = query };
        
        // 1. è‡ªç„¶è¯­è¨€å¤„ç†
        var nlpResult = await _nlpService.AnalyzeQueryAsync(query);
        processed.Intent = nlpResult.Intent;
        processed.Entities = nlpResult.Entities;
        
        // 2. æŸ¥è¯¢æ‰©å±•
        var expandedTerms = await _queryExpansionService.ExpandQueryAsync(query, userId);
        processed.EnhancedQuery = BuildEnhancedQuery(query, expandedTerms);
        
        // 3. æ‹¼å†™æ£€æŸ¥å’Œçº æ­£
        var spellCheck = await _spellCheckService.CheckSpellingAsync(query);
        if (spellCheck.HasCorrections)
        {
            processed.SuggestedCorrection = spellCheck.CorrectedQuery;
        }
        
        // 4. å®ä½“è¯†åˆ«å’Œç±»å‹æ¨æ–­
        processed.EntityTypes = InferEntityTypes(nlpResult.Entities);
        
        return processed;
    }
    
    private async Task<string> BuildPermissionFilter(string userId)
    {
        // 1. è·å–ç”¨æˆ·æƒé™ä¸Šä¸‹æ–‡
        var userContext = await _permissionService.GetUserContextAsync(userId);
        
        var filterParts = new List<string>();
        
        // 2. æ·»åŠ ç»„ç»‡æƒé™è¿‡æ»¤
        if (userContext.Organizations.Any())
        {
            var orgFilter = string.Join(" or ", 
                userContext.Organizations.Select(org => $"organization eq '{org}'"));
            filterParts.Add($"({orgFilter})");
        }
        
        // 3. æ·»åŠ éƒ¨é—¨æƒé™è¿‡æ»¤
        if (userContext.Departments.Any())
        {
            var deptFilter = string.Join(" or ",
                userContext.Departments.Select(dept => $"department eq '{dept}'"));
            filterParts.Add($"({deptFilter})");
        }
        
        // 4. æ·»åŠ ä¸ªäººè®¿é—®æƒé™
        filterParts.Add($"(owner eq '{userId}' or sharedWith/any(user: user eq '{userId}'))");
        
        // 5. æ·»åŠ å…¬å¼€å†…å®¹è¿‡æ»¤
        filterParts.Add("isPublic eq true");
        
        return string.Join(" or ", filterParts);
    }
    
    private async Task<List<SearchResult>> ProcessSearchResults(
        SearchResults<SearchDocument> rawResults,
        string userId,
        PersonalizationParams personalizationParams)
    {
        var results = new List<SearchResult>();
        
        foreach (var doc in rawResults.GetResults())
        {
            // 1. æƒé™äºŒæ¬¡éªŒè¯
            if (!await _permissionService.CanAccessDocumentAsync(userId, doc.Document["id"].ToString()))
            {
                continue; // è·³è¿‡æ— æƒé™è®¿é—®çš„æ–‡æ¡£
            }
            
            // 2. å†…å®¹æ‘˜è¦ç”Ÿæˆ
            var summary = await GenerateContentSummary(doc.Document, personalizationParams.PreferredSummaryLength);
            
            // 3. ç›¸å…³æ€§å¾—åˆ†è°ƒæ•´
            var adjustedScore = AdjustRelevanceScore(doc.Score.Value, doc.Document, personalizationParams);
            
            // 4. æ„å»ºæœç´¢ç»“æœ
            var result = new SearchResult
            {
                Id = doc.Document["id"].ToString(),
                Title = doc.Document["title"]?.ToString(),
                Summary = summary,
                Url = doc.Document["url"]?.ToString(),
                Source = doc.Document["source"]?.ToString(),
                LastModified = DateTime.Parse(doc.Document["lastModified"].ToString()),
                Author = doc.Document["author"]?.ToString(),
                RelevanceScore = adjustedScore,
                Highlights = ExtractHighlights(doc.Highlights)
            };
            
            results.Add(result);
        }
        
        // 5. åŸºäºç”¨æˆ·åå¥½é‡æ–°æ’åº
        return results.OrderByDescending(r => r.RelevanceScore).ToList();
    }
}
```

### 3. å…¨çƒåŒ–å†…å®¹åˆ†å‘å¹³å°

#### é¢˜ç›®3ï¼šè®¾è®¡ç±»ä¼¼Office 365çš„å…¨çƒåŒ–SaaSå¹³å°
**é—®é¢˜**ï¼šè®¾è®¡ä¸€ä¸ªæ”¯æŒå…¨çƒç”¨æˆ·çš„SaaSå¹³å°ï¼Œè¦æ±‚æ”¯æŒå¤šç§Ÿæˆ·ã€å¤šåŒºåŸŸéƒ¨ç½²ã€æ•°æ®æœ¬åœ°åŒ–å’Œåˆè§„æ€§è¦æ±‚ã€‚

**å…¨çƒåŒ–æ¶æ„è®¾è®¡**ï¼š
```mermaid
graph TB
    subgraph "å…¨çƒç”¨æˆ·"
        A[åŒ—ç¾ç”¨æˆ·]
        B[æ¬§æ´²ç”¨æˆ·]
        C[äºšå¤ªç”¨æˆ·]
        D[å…¶ä»–åŒºåŸŸ]
    end
    
    subgraph "è¾¹ç¼˜ç½‘ç»œ"
        E[Azure Front Door]
        F[å…¨çƒCDN]
        G[è¾¹ç¼˜ç¼“å­˜]
    end
    
    subgraph "åŒºåŸŸéƒ¨ç½²"
        subgraph "ç¾å›½ä¸œéƒ¨"
            H1[APIç½‘å…³]
            I1[åº”ç”¨æœåŠ¡]
            J1[æ•°æ®åº“ä¸»èŠ‚ç‚¹]
            K1[å­˜å‚¨æœåŠ¡]
        end
        
        subgraph "æ¬§æ´²è¥¿éƒ¨"
            H2[APIç½‘å…³]
            I2[åº”ç”¨æœåŠ¡]
            J2[æ•°æ®åº“å‰¯æœ¬]
            K2[å­˜å‚¨æœåŠ¡]
        end
        
        subgraph "äºšå¤ªåœ°åŒº"
            H3[APIç½‘å…³]
            I3[åº”ç”¨æœåŠ¡]
            J3[æ•°æ®åº“å‰¯æœ¬]
            K3[å­˜å‚¨æœåŠ¡]
        end
    end
    
    subgraph "å…¨çƒæœåŠ¡"
        L[ç”¨æˆ·ç›®å½•æœåŠ¡]
        M[ç§Ÿæˆ·ç®¡ç†]
        N[é…ç½®ç®¡ç†]
        O[ç›‘æ§ä¸­å¿ƒ]
    end
    
    subgraph "æ•°æ®åˆè§„"
        P[GDPRåˆè§„]
        Q[æ•°æ®é©»ç•™]
        R[å®¡è®¡æ—¥å¿—]
        S[åŠ å¯†æœåŠ¡]
    end
    
    A --> E
    B --> E
    C --> E
    D --> E
    
    E --> F
    F --> G
    
    G --> H1
    G --> H2
    G --> H3
    
    H1 --> I1
    H2 --> I2
    H3 --> I3
    
    I1 --> J1
    I2 --> J2
    I3 --> J3
    
    I1 --> L
    I2 --> L
    I3 --> L
    
    L --> M
    M --> N
    N --> O
    
    J1 --> P
    J2 --> Q
    J3 --> R
    K1 --> S
```

**å¤šç§Ÿæˆ·æ•°æ®æ¶æ„**ï¼š
```csharp
public class MultiTenantDataService
{
    private readonly ITenantResolver _tenantResolver;
    private readonly IDataPartitioningService _partitioningService;
    private readonly IDataResidencyService _dataResidencyService;
    
    public async Task<T> GetTenantDataAsync<T>(string tenantId, string dataId) where T : class
    {
        // 1. è§£æç§Ÿæˆ·ä¿¡æ¯
        var tenant = await _tenantResolver.ResolveTenantAsync(tenantId);
        
        // 2. ç¡®å®šæ•°æ®å­˜å‚¨ä½ç½®
        var dataLocation = await _dataResidencyService.GetDataLocationAsync(tenant);
        
        // 3. è·å–åˆ†ç‰‡ä¿¡æ¯
        var partition = await _partitioningService.GetPartitionAsync(tenantId, dataId);
        
        // 4. è¿æ¥åˆ°æ­£ç¡®çš„æ•°æ®åº“
        var connectionString = GetConnectionString(dataLocation.Region, partition.DatabaseId);
        var context = CreateDbContext(connectionString);
        
        // 5. åº”ç”¨ç§Ÿæˆ·è¿‡æ»¤
        var query = context.Set<T>()
            .Where(e => EF.Property<string>(e, "TenantId") == tenantId)
            .Where(e => EF.Property<string>(e, "Id") == dataId);
        
        return await query.FirstOrDefaultAsync();
    }
    
    public async Task SaveTenantDataAsync<T>(T entity, string tenantId) where T : class
    {
        // 1. éªŒè¯æ•°æ®åˆè§„æ€§
        await ValidateDataComplianceAsync(entity, tenantId);
        
        // 2. è§£æç§Ÿæˆ·é…ç½®
        var tenant = await _tenantResolver.ResolveTenantAsync(tenantId);
        
        // 3. åº”ç”¨æ•°æ®é©»ç•™ç­–ç•¥
        var dataLocation = await _dataResidencyService.EnsureDataResidencyAsync(tenant, entity);
        
        // 4. ç¡®å®šæ•°æ®åˆ†ç‰‡
        var partition = await _partitioningService.ResolvePartitionAsync(tenantId, entity);
        
        // 5. æ•°æ®åŠ å¯†å¤„ç†
        var encryptedEntity = await EncryptSensitiveDataAsync(entity, tenant.EncryptionKey);
        
        // 6. ä¿å­˜åˆ°å¯¹åº”åˆ†ç‰‡
        var connectionString = GetConnectionString(dataLocation.Region, partition.DatabaseId);
        var context = CreateDbContext(connectionString);
        
        // è®¾ç½®ç§Ÿæˆ·æ ‡è¯†
        context.Entry(encryptedEntity).Property("TenantId").CurrentValue = tenantId;
        context.Entry(encryptedEntity).Property("CreatedAt").CurrentValue = DateTime.UtcNow;
        
        context.Set<T>().Add(encryptedEntity);
        await context.SaveChangesAsync();
        
        // 7. å®¡è®¡æ—¥å¿—è®°å½•
        await RecordAuditLogAsync(tenantId, "DataSaved", typeof(T).Name, entity);
        
        // 8. æ•°æ®åŒæ­¥åˆ°å…¶ä»–åŒºåŸŸï¼ˆå¦‚æœéœ€è¦ï¼‰
        if (tenant.RequiresGlobalReplication)
        {
            await ReplicateToOtherRegionsAsync(encryptedEntity, tenantId);
        }
    }
}

// æ•°æ®åˆè§„æœåŠ¡
public class DataComplianceService
{
    private readonly IGdprService _gdprService;
    private readonly IDataClassificationService _classificationService;
    
    public async Task<ComplianceResult> ValidateDataComplianceAsync<T>(T entity, string tenantId)
    {
        var result = new ComplianceResult { IsCompliant = true };
        
        // 1. æ•°æ®åˆ†ç±»
        var classification = await _classificationService.ClassifyDataAsync(entity);
        
        // 2. GDPRåˆè§„æ£€æŸ¥
        if (classification.ContainsPersonalData)
        {
            var gdprResult = await _gdprService.ValidateGdprComplianceAsync(entity, tenantId);
            result.GdprCompliant = gdprResult.IsCompliant;
            result.RequiredActions.AddRange(gdprResult.RequiredActions);
        }
        
        // 3. æ•°æ®é©»ç•™æ£€æŸ¥
        var tenant = await GetTenantAsync(tenantId);
        if (tenant.DataResidencyRequirements.Any())
        {
            var residencyResult = await ValidateDataResidencyAsync(entity, tenant);
            result.ResidencyCompliant = residencyResult.IsCompliant;
            result.RequiredActions.AddRange(residencyResult.RequiredActions);
        }
        
        // 4. è¡Œä¸šç‰¹å®šåˆè§„æ£€æŸ¥ï¼ˆå¦‚HIPAAã€SOXç­‰ï¼‰
        if (tenant.IndustryCompliance.Any())
        {
            foreach (var compliance in tenant.IndustryCompliance)
            {
                var industryResult = await ValidateIndustryComplianceAsync(entity, compliance);
                result.IndustryCompliance[compliance] = industryResult;
            }
        }
        
        result.IsCompliant = result.GdprCompliant && result.ResidencyCompliant && 
                           result.IndustryCompliance.Values.All(r => r.IsCompliant);
        
        return result;
    }
}
```

## ğŸ“Š é¢è¯•è¯„åˆ†æ ‡å‡†

### ç³»ç»Ÿè®¾è®¡æ€ç»´ (40%)
- **éœ€æ±‚åˆ†æ**ï¼šå‡†ç¡®ç†è§£å’Œåˆ†è§£ä¸šåŠ¡éœ€æ±‚
- **æ¶æ„è®¾è®¡**ï¼šè®¾è®¡åˆç†çš„æ•´ä½“æ¶æ„
- **æŠ€æœ¯é€‰å‹**ï¼šé€‰æ‹©é€‚åˆçš„æŠ€æœ¯æ ˆå’ŒæœåŠ¡
- **æ‰©å±•æ€§è€ƒè™‘**ï¼šè®¾è®¡å¯æ‰©å±•çš„ç³»ç»Ÿæ¶æ„

### æŠ€æœ¯æ·±åº¦ (30%)
- **å¾®è½¯æŠ€æœ¯æ ˆ**ï¼šå……åˆ†åˆ©ç”¨Azureå’Œ.NETç”Ÿæ€
- **ä¼ä¸šçº§ç‰¹æ€§**ï¼šè€ƒè™‘å®‰å…¨ã€åˆè§„ã€å¤šç§Ÿæˆ·ç­‰ä¼ä¸šéœ€æ±‚
- **æ€§èƒ½ä¼˜åŒ–**ï¼šè¯†åˆ«æ€§èƒ½ç“¶é¢ˆå¹¶æå‡ºä¼˜åŒ–æ–¹æ¡ˆ
- **æ•…éšœå¤„ç†**ï¼šè®¾è®¡å®¹é”™å’Œæ¢å¤æœºåˆ¶

### å®è·µç»éªŒ (20%)
- **ç°å®è€ƒè™‘**ï¼šè€ƒè™‘å®é™…å®æ–½ä¸­çš„æŒ‘æˆ˜
- **è¿ç»´è€ƒè™‘**ï¼šç›‘æ§ã€æ—¥å¿—ã€éƒ¨ç½²ç­‰è¿ç»´é—®é¢˜
- **æˆæœ¬è€ƒè™‘**ï¼šåœ¨æ€§èƒ½å’Œæˆæœ¬é—´å¹³è¡¡
- **è¿­ä»£æ€ç»´**ï¼šMVPåˆ°å®Œæ•´ç³»ç»Ÿçš„æ¼”è¿›è·¯å¾„

### æ²Ÿé€šè¡¨è¾¾ (10%)
- **æ¸…æ™°è¡¨è¾¾**ï¼šèƒ½å¤Ÿæ¸…æ¥šåœ°è¡¨è¾¾è®¾è®¡æ€è·¯
- **äº’åŠ¨è®¨è®º**ï¼šä¸»åŠ¨è¯¢é—®éœ€æ±‚ç»†èŠ‚å’Œçº¦æŸæ¡ä»¶
- **æƒè¡¡è¯´æ˜**ï¼šèƒ½å¤Ÿè§£é‡Šè®¾è®¡å†³ç­–çš„æƒè¡¡è€ƒè™‘
- **å›¾è¡¨è¾…åŠ©**ï¼šä½¿ç”¨å›¾è¡¨ç­‰å·¥å…·è¾…åŠ©è¯´æ˜

## ğŸ¯ å¤‡è€ƒå»ºè®®

### ç³»ç»Ÿè®¾è®¡å‡†å¤‡
1. **å­¦ä¹ å¾®è½¯äº§å“æ¶æ„**ï¼šæ·±å…¥äº†è§£Office 365ã€Teamsã€Azureç­‰äº§å“æ¶æ„
2. **æŒæ¡AzureæœåŠ¡**ï¼šç†Ÿæ‚‰å„ç§AzureæœåŠ¡çš„ç‰¹æ€§å’Œä½¿ç”¨åœºæ™¯
3. **ä¼ä¸šçº§è€ƒè™‘**ï¼šé‡ç‚¹å…³æ³¨å®‰å…¨ã€åˆè§„ã€å¤šç§Ÿæˆ·ç­‰ä¼ä¸šç‰¹æ€§
4. **å®é™…é¡¹ç›®ç»éªŒ**ï¼šç§¯ç´¯å¤§è§„æ¨¡ç³»ç»Ÿè®¾è®¡å’Œå®æ–½ç»éªŒ

### é¢è¯•æŠ€å·§
1. **éœ€æ±‚æ¾„æ¸…**ï¼šä¸»åŠ¨è¯¢é—®ç³»ç»Ÿè§„æ¨¡ã€æ€§èƒ½è¦æ±‚ã€çº¦æŸæ¡ä»¶
2. **åˆ†æ­¥è®¾è®¡**ï¼šä»é«˜å±‚æ¶æ„å¼€å§‹ï¼Œé€æ­¥ç»†åŒ–å„ä¸ªç»„ä»¶
3. **æƒè¡¡åˆ†æ**ï¼šå¯¹é‡è¦çš„è®¾è®¡å†³ç­–è¿›è¡Œæƒè¡¡åˆ†æ
4. **æ¼”è¿›æ€ç»´**ï¼šå±•ç¤ºç³»ç»Ÿä»MVPåˆ°å®Œæ•´æ–¹æ¡ˆçš„æ¼”è¿›è¿‡ç¨‹

### é‡ç‚¹å…³æ³¨é¢†åŸŸ
- **å¾®æœåŠ¡æ¶æ„**å’Œåˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡
- **äº‘åŸç”Ÿ**åº”ç”¨æ¶æ„æ¨¡å¼
- **æ•°æ®ä¸€è‡´æ€§**å’Œåˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†
- **å…¨çƒåŒ–éƒ¨ç½²**å’Œå¤šåŒºåŸŸæ¶æ„
- **ä¼ä¸šå®‰å…¨**å’Œåˆè§„è¦æ±‚

---
[â† è¿”å›å¾®è½¯é¢è¯•é¢˜åº“](./README.md) 