# é˜¿é‡Œå·´å·´æ”¯ä»˜ç³»ç»Ÿè®¾è®¡é¢è¯•é¢˜

## ğŸ“š é¢˜ç›®æ¦‚è§ˆ

æ”¯ä»˜ç³»ç»Ÿæ˜¯é˜¿é‡Œå·´å·´ç”Ÿæ€çš„æ ¸å¿ƒç»„æˆéƒ¨åˆ†ï¼Œé¢è¯•é‡ç‚¹è€ƒå¯Ÿå€™é€‰äººå¯¹æ”¯ä»˜ä¸šåŠ¡æµç¨‹ã€å®‰å…¨é£æ§ã€åˆ†å¸ƒå¼äº‹åŠ¡ã€å¯¹è´¦æ¸…ç»“ç®—ç­‰æ ¸å¿ƒèƒ½åŠ›ã€‚ä½œä¸ºèš‚èšé‡‘æœå’Œæ”¯ä»˜å®çš„æŠ€æœ¯åº•å±‚ï¼Œæ”¯ä»˜ç³»ç»Ÿè¦æ±‚æé«˜çš„å¯é æ€§ã€ä¸€è‡´æ€§å’Œå®‰å…¨æ€§ã€‚

## ğŸ’° æ ¸å¿ƒä¸šåŠ¡æ¨¡å—

### æ”¯ä»˜ç½‘å…³ç³»ç»Ÿ
- **æ¸ é“è·¯ç”±**ï¼šå¤šæ”¯ä»˜æ¸ é“ç»Ÿä¸€æ¥å…¥å’Œè·¯ç”±
- **åè®®é€‚é…**ï¼šä¸åŒæ”¯ä»˜æœºæ„åè®®è½¬æ¢
- **é™æµç†”æ–­**ï¼šé«˜å¹¶å‘åœºæ™¯ä¸‹çš„æµé‡æ§åˆ¶
- **å®‰å…¨é˜²æŠ¤**ï¼šé˜²é‡å¤æäº¤ã€é˜²ç¯¡æ”¹ã€åŠ å¯†è§£å¯†

### è´¦æˆ·ç³»ç»Ÿ
- **è´¦æˆ·æ¨¡å‹**ï¼šç”¨æˆ·è´¦æˆ·ã€å•†æˆ·è´¦æˆ·ã€å¹³å°è´¦æˆ·
- **ä½™é¢ç®¡ç†**ï¼šå®æ—¶ä½™é¢ã€å†»ç»“é‡‘é¢ã€å¯ç”¨ä½™é¢
- **è®°è´¦ç³»ç»Ÿ**ï¼šå¤å¼è®°è´¦ã€ä¼šè®¡åˆ†å½•ã€è´¦åŠ¡æ ¸å¯¹
- **èµ„é‡‘å®‰å…¨**ï¼šå¯†ç éªŒè¯ã€é™é¢æ§åˆ¶ã€é£é™©è¯†åˆ«

### é£æ§ç³»ç»Ÿ
- **å®æ—¶é£æ§**ï¼šäº¤æ˜“å®æ—¶ç›‘æ§å’Œæ‹¦æˆª
- **è§„åˆ™å¼•æ“**ï¼šå¯é…ç½®çš„é£æ§è§„åˆ™å’Œç­–ç•¥
- **æœºå™¨å­¦ä¹ **ï¼šå¼‚å¸¸æ£€æµ‹å’Œåæ¬ºè¯ˆæ¨¡å‹
- **äººå·¥å®¡æ ¸**ï¼šå¯ç–‘äº¤æ˜“äººå·¥å¤æ ¸æµç¨‹

### æ¸…ç»“ç®—ç³»ç»Ÿ
- **å¯¹è´¦å¤„ç†**ï¼šä¸é“¶è¡Œå’Œç¬¬ä¸‰æ–¹æ”¯ä»˜å¯¹è´¦
- **æ¸…ç®—å¤„ç†**ï¼šèµ„é‡‘æ¸…ç®—å’Œåˆ†æ¶¦è®¡ç®—
- **ç»“ç®—å¤„ç†**ï¼šå•†æˆ·èµ„é‡‘ç»“ç®—å’Œæç°
- **è´¢åŠ¡æŠ¥è¡¨**ï¼šå„ç»´åº¦è´¢åŠ¡æ•°æ®ç»Ÿè®¡

## ğŸ“ æ ¸å¿ƒé¢è¯•é¢˜ç›®

### 1. æ”¯ä»˜ç³»ç»Ÿæ•´ä½“æ¶æ„

#### é¢˜ç›®1ï¼šè®¾è®¡é«˜å¯ç”¨çš„æ”¯ä»˜ç³»ç»Ÿæ¶æ„
**é—®é¢˜**ï¼šè®¾è®¡ä¸€ä¸ªæ”¯æ’‘æ—¥äº¤æ˜“é‡1äº¿ç¬”çš„æ”¯ä»˜ç³»ç»Ÿï¼Œè¦æ±‚99.999%å¯ç”¨æ€§ï¼Œæ”¯æŒå¤šç§æ”¯ä»˜æ–¹å¼ã€‚

**æ¶æ„è®¾è®¡**ï¼š

```mermaid
graph TB
    subgraph "æ¥å…¥å±‚"
        A[ç§»åŠ¨APP]
        B[Webç½‘ç«™]
        C[ç¬¬ä¸‰æ–¹æ¥å…¥]
    end
    
    subgraph "ç½‘å…³å±‚"
        D[APIç½‘å…³]
        E[æ”¯ä»˜ç½‘å…³]
        F[è·¯ç”±ç³»ç»Ÿ]
    end
    
    subgraph "åº”ç”¨å±‚"
        G[è®¢å•æœåŠ¡]
        H[æ”¯ä»˜æœåŠ¡]
        I[è´¦æˆ·æœåŠ¡]
        J[é£æ§æœåŠ¡]
        K[é€šçŸ¥æœåŠ¡]
    end
    
    subgraph "æ ¸å¿ƒå±‚"
        L[è´¦åŠ¡æ ¸å¿ƒ]
        M[æ¸…ç»“ç®—æ ¸å¿ƒ]
        N[å¯¹è´¦æ ¸å¿ƒ]
    end
    
    subgraph "æ¸ é“å±‚"
        O[é“¶è”é€šé“]
        P[é“¶è¡Œé€šé“]
        Q[ç¬¬ä¸‰æ–¹æ”¯ä»˜]
    end
    
    A --> D
    B --> D
    C --> D
    D --> E
    E --> F
    F --> G
    F --> H
    F --> I
    F --> J
    G --> L
    H --> L
    I --> L
    J --> L
    L --> M
    M --> N
    H --> O
    H --> P
    H --> Q
```

**æ ¸å¿ƒè®¾è®¡åŸåˆ™**ï¼š
```yaml
# æ”¯ä»˜ç³»ç»Ÿè®¾è®¡åŸåˆ™
å¯é æ€§:
  - æ•°æ®ä¸€è‡´æ€§: å¼ºä¸€è‡´æ€§ä¿è¯
  - å¹‚ç­‰æ€§: é‡å¤è¯·æ±‚ç›¸åŒç»“æœ
  - äº‹åŠ¡æ€§: ACIDç‰¹æ€§ä¿éšœ
  - å®¹é”™æ€§: æ•…éšœè‡ªåŠ¨æ¢å¤

å®‰å…¨æ€§:
  - åŠ å¯†ä¼ è¾“: HTTPS + æŠ¥æ–‡åŠ å¯†
  - èº«ä»½è®¤è¯: å¤šå› å­èº«ä»½éªŒè¯
  - æƒé™æ§åˆ¶: æœ€å°æƒé™åŸåˆ™
  - å®¡è®¡æ—¥å¿—: å®Œæ•´æ“ä½œè½¨è¿¹

æ€§èƒ½:
  - é«˜å¹¶å‘: æ”¯æŒä¸‡çº§TPS
  - ä½å»¶è¿Ÿ: ç§’çº§å“åº”æ—¶é—´
  - é«˜å¯ç”¨: 99.999%å¯ç”¨æ€§
  - å¼¹æ€§æ‰©å®¹: è‡ªåŠ¨ä¼¸ç¼©èƒ½åŠ›

åˆè§„æ€§:
  - ç›‘ç®¡è¦æ±‚: å¤®è¡Œæ”¯ä»˜è§„èŒƒ
  - é£æ§è§„åˆ™: åæ´—é’±è§„åˆ™
  - æ•°æ®ä¿æŠ¤: ä¸ªäººä¿¡æ¯ä¿æŠ¤
  - å®¡è®¡è¦æ±‚: å®Œæ•´å®¡è®¡è½¨è¿¹
```

#### é¢˜ç›®2ï¼šæ”¯ä»˜æµç¨‹çŠ¶æ€æœºè®¾è®¡
**é—®é¢˜**ï¼šè®¾è®¡æ”¯ä»˜è®¢å•çš„çŠ¶æ€æµè½¬æœºåˆ¶ï¼Œè¦æ±‚æ”¯æŒå„ç§å¼‚å¸¸åœºæ™¯å’Œè¡¥å¿é€»è¾‘ã€‚

**çŠ¶æ€æœºè®¾è®¡**ï¼š
```mermaid
stateDiagram-v2
    [*] --> åˆ›å»ºæ”¯ä»˜å•: å‘èµ·æ”¯ä»˜
    åˆ›å»ºæ”¯ä»˜å• --> æ”¯ä»˜ä¸­: è°ƒç”¨æ”¯ä»˜æ¸ é“
    æ”¯ä»˜ä¸­ --> æ”¯ä»˜æˆåŠŸ: æ¸ é“è¿”å›æˆåŠŸ
    æ”¯ä»˜ä¸­ --> æ”¯ä»˜å¤±è´¥: æ¸ é“è¿”å›å¤±è´¥
    æ”¯ä»˜ä¸­ --> æ”¯ä»˜è¶…æ—¶: ç­‰å¾…è¶…æ—¶
    æ”¯ä»˜è¶…æ—¶ --> æŸ¥è¯¢ä¸­: ä¸»åŠ¨æŸ¥è¯¢
    æŸ¥è¯¢ä¸­ --> æ”¯ä»˜æˆåŠŸ: æŸ¥è¯¢åˆ°æˆåŠŸ
    æŸ¥è¯¢ä¸­ --> æ”¯ä»˜å¤±è´¥: æŸ¥è¯¢åˆ°å¤±è´¥
    æŸ¥è¯¢ä¸­ --> äººå·¥å¤„ç†: æŸ¥è¯¢å¼‚å¸¸
    äººå·¥å¤„ç† --> æ”¯ä»˜æˆåŠŸ: äººå·¥ç¡®è®¤æˆåŠŸ
    äººå·¥å¤„ç† --> æ”¯ä»˜å¤±è´¥: äººå·¥ç¡®è®¤å¤±è´¥
    æ”¯ä»˜æˆåŠŸ --> é€€æ¬¾ä¸­: å‘èµ·é€€æ¬¾
    é€€æ¬¾ä¸­ --> é€€æ¬¾æˆåŠŸ: é€€æ¬¾å®Œæˆ
    é€€æ¬¾ä¸­ --> é€€æ¬¾å¤±è´¥: é€€æ¬¾å¤±è´¥
    æ”¯ä»˜å¤±è´¥ --> [*]
    é€€æ¬¾æˆåŠŸ --> [*]
    é€€æ¬¾å¤±è´¥ --> [*]
```

**çŠ¶æ€æœºå®ç°**ï¼š
```java
@Component
@Slf4j
public class PaymentStateMachine {
    
    @Autowired
    private PaymentOrderMapper paymentOrderMapper;
    
    @Autowired
    private PaymentChannelService channelService;
    
    // çŠ¶æ€è½¬æ¢å¤„ç†
    public PaymentStateResult processStateTransition(Long paymentId, 
                                                   PaymentEvent event, 
                                                   Map<String, Object> context) {
        
        PaymentOrder order = paymentOrderMapper.selectById(paymentId);
        PaymentStatus fromStatus = order.getStatus();
        PaymentStatus toStatus = getNextStatus(fromStatus, event);
        
        // çŠ¶æ€è½¬æ¢å‰ç½®æ£€æŸ¥
        if (!isValidTransition(fromStatus, toStatus)) {
            return PaymentStateResult.failure("æ— æ•ˆçš„çŠ¶æ€è½¬æ¢");
        }
        
        try {
            // æ‰§è¡ŒçŠ¶æ€è½¬æ¢
            return executeTransition(order, fromStatus, toStatus, event, context);
            
        } catch (Exception e) {
            log.error("æ”¯ä»˜çŠ¶æ€è½¬æ¢å¤±è´¥: paymentId={}, from={}, to={}", 
                paymentId, fromStatus, toStatus, e);
            return PaymentStateResult.failure("çŠ¶æ€è½¬æ¢å¼‚å¸¸");
        }
    }
    
    private PaymentStateResult executeTransition(PaymentOrder order,
                                               PaymentStatus fromStatus,
                                               PaymentStatus toStatus,
                                               PaymentEvent event,
                                               Map<String, Object> context) {
        
        switch (toStatus) {
            case PAYING:
                return handlePaying(order, context);
                
            case SUCCESS:
                return handleSuccess(order, context);
                
            case FAILED:
                return handleFailed(order, context);
                
            case TIMEOUT:
                return handleTimeout(order, context);
                
            case QUERYING:
                return handleQuerying(order, context);
                
            case MANUAL_PROCESSING:
                return handleManualProcessing(order, context);
                
            default:
                return PaymentStateResult.failure("æœªçŸ¥çŠ¶æ€");
        }
    }
    
    // å¤„ç†æ”¯ä»˜ä¸­çŠ¶æ€
    private PaymentStateResult handlePaying(PaymentOrder order, Map<String, Object> context) {
        // è°ƒç”¨æ”¯ä»˜æ¸ é“
        PaymentRequest request = buildPaymentRequest(order);
        PaymentResponse response = channelService.pay(request);
        
        // æ›´æ–°è®¢å•çŠ¶æ€
        order.setStatus(PaymentStatus.PAYING);
        order.setChannelOrderId(response.getChannelOrderId());
        order.setUpdateTime(new Date());
        paymentOrderMapper.updateById(order);
        
        // å¯åŠ¨çŠ¶æ€æŸ¥è¯¢ä»»åŠ¡
        scheduleStatusQuery(order.getId());
        
        return PaymentStateResult.success();
    }
    
    // å¤„ç†æ”¯ä»˜æˆåŠŸçŠ¶æ€
    private PaymentStateResult handleSuccess(PaymentOrder order, Map<String, Object> context) {
        // æ›´æ–°è®¢å•çŠ¶æ€
        order.setStatus(PaymentStatus.SUCCESS);
        order.setFinishTime(new Date());
        paymentOrderMapper.updateById(order);
        
        // è®°å½•è´¦åŠ¡æµæ°´
        accountingService.recordTransaction(order);
        
        // å‘é€æˆåŠŸé€šçŸ¥
        notificationService.sendPaymentSuccess(order);
        
        // å›è°ƒä¸šåŠ¡ç³»ç»Ÿ
        callbackService.notifyBusiness(order);
        
        return PaymentStateResult.success();
    }
}
```

### 2. è´¦æˆ·å’Œèµ„é‡‘ç®¡ç†

#### é¢˜ç›®3ï¼šè®¾è®¡å¤šè´¦æˆ·èµ„é‡‘ç®¡ç†ç³»ç»Ÿ
**é—®é¢˜**ï¼šè®¾è®¡æ”¯æŒç”¨æˆ·ã€å•†æˆ·ã€å¹³å°çš„å¤šè´¦æˆ·ä½“ç³»ï¼Œè¦æ±‚èµ„é‡‘å®‰å…¨ã€è´¦åŠ¡æ¸…æ™°ã€‚

**è´¦æˆ·æ¨¡å‹è®¾è®¡**ï¼š
```sql
-- è´¦æˆ·ä¸»è¡¨
CREATE TABLE `account_info` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `account_no` varchar(32) NOT NULL COMMENT 'è´¦æˆ·å·',
  `user_id` bigint(20) NOT NULL COMMENT 'ç”¨æˆ·ID',
  `account_type` tinyint(4) NOT NULL COMMENT 'è´¦æˆ·ç±»å‹',
  `currency` varchar(3) NOT NULL DEFAULT 'CNY' COMMENT 'å¸ç§',
  `status` tinyint(4) NOT NULL DEFAULT '1' COMMENT 'è´¦æˆ·çŠ¶æ€',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_account_no` (`account_no`),
  KEY `idx_user_id` (`user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- è´¦æˆ·ä½™é¢è¡¨
CREATE TABLE `account_balance` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `account_no` varchar(32) NOT NULL COMMENT 'è´¦æˆ·å·',
  `balance` decimal(20,2) NOT NULL DEFAULT '0.00' COMMENT 'å¯ç”¨ä½™é¢',
  `frozen_amount` decimal(20,2) NOT NULL DEFAULT '0.00' COMMENT 'å†»ç»“é‡‘é¢',
  `total_amount` decimal(20,2) NOT NULL DEFAULT '0.00' COMMENT 'æ€»é‡‘é¢',
  `version` int(11) NOT NULL DEFAULT '0' COMMENT 'ç‰ˆæœ¬å·',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_account_no` (`account_no`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- è´¦åŠ¡æµæ°´è¡¨
CREATE TABLE `accounting_entry` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `entry_id` varchar(32) NOT NULL COMMENT 'åˆ†å½•ID',
  `business_id` varchar(32) NOT NULL COMMENT 'ä¸šåŠ¡å•å·',
  `account_no` varchar(32) NOT NULL COMMENT 'è´¦æˆ·å·',
  `direction` tinyint(4) NOT NULL COMMENT 'å€Ÿè´·æ–¹å‘',
  `amount` decimal(20,2) NOT NULL COMMENT 'é‡‘é¢',
  `currency` varchar(3) NOT NULL DEFAULT 'CNY',
  `subject_code` varchar(16) NOT NULL COMMENT 'ç§‘ç›®ä»£ç ',
  `business_type` varchar(16) NOT NULL COMMENT 'ä¸šåŠ¡ç±»å‹',
  `remark` varchar(200) DEFAULT NULL COMMENT 'å¤‡æ³¨',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_entry_id` (`entry_id`),
  KEY `idx_business_id` (`business_id`),
  KEY `idx_account_no` (`account_no`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

**èµ„é‡‘æ“ä½œæœåŠ¡**ï¼š
```java
@Service
@Transactional
public class AccountService {
    
    @Autowired
    private AccountBalanceMapper balanceMapper;
    
    @Autowired
    private AccountingEntryMapper entryMapper;
    
    @Autowired
    private DistributedLock distributedLock;
    
    // ä½™é¢å˜åŠ¨ï¼ˆå¸¦é”çš„åŸå­æ“ä½œï¼‰
    public BalanceChangeResult changeBalance(BalanceChangeRequest request) {
        String lockKey = "account:balance:" + request.getAccountNo();
        
        return distributedLock.execute(lockKey, 10, TimeUnit.SECONDS, () -> {
            // 1. æŸ¥è¯¢å½“å‰ä½™é¢
            AccountBalance balance = balanceMapper.selectByAccountNo(request.getAccountNo());
            if (balance == null) {
                throw new BusinessException("è´¦æˆ·ä¸å­˜åœ¨");
            }
            
            // 2. è®¡ç®—å˜åŠ¨åä½™é¢
            BigDecimal newBalance = balance.getBalance().add(request.getAmount());
            BigDecimal newFrozen = balance.getFrozenAmount();
            
            if (request.getChangeType() == ChangeType.FREEZE) {
                // å†»ç»“æ“ä½œ
                if (newBalance.compareTo(request.getAmount()) < 0) {
                    throw new BusinessException("ä½™é¢ä¸è¶³");
                }
                newBalance = balance.getBalance().subtract(request.getAmount());
                newFrozen = balance.getFrozenAmount().add(request.getAmount());
                
            } else if (request.getChangeType() == ChangeType.UNFREEZE) {
                // è§£å†»æ“ä½œ
                if (balance.getFrozenAmount().compareTo(request.getAmount()) < 0) {
                    throw new BusinessException("å†»ç»“é‡‘é¢ä¸è¶³");
                }
                newBalance = balance.getBalance().add(request.getAmount());
                newFrozen = balance.getFrozenAmount().subtract(request.getAmount());
            }
            
            // 3. æ›´æ–°ä½™é¢ï¼ˆä¹è§‚é”ï¼‰
            AccountBalance updateBalance = new AccountBalance();
            updateBalance.setId(balance.getId());
            updateBalance.setBalance(newBalance);
            updateBalance.setFrozenAmount(newFrozen);
            updateBalance.setTotalAmount(newBalance.add(newFrozen));
            updateBalance.setVersion(balance.getVersion() + 1);
            
            int updateRows = balanceMapper.updateByVersion(updateBalance, balance.getVersion());
            if (updateRows == 0) {
                throw new ConcurrentModificationException("ä½™é¢å¹¶å‘ä¿®æ”¹å†²çª");
            }
            
            // 4. è®°å½•è´¦åŠ¡æµæ°´
            recordAccountingEntry(request, balance, updateBalance);
            
            return BalanceChangeResult.success(newBalance);
        });
    }
    
    // å¤å¼è®°è´¦
    private void recordAccountingEntry(BalanceChangeRequest request, 
                                     AccountBalance oldBalance, 
                                     AccountBalance newBalance) {
        
        String entryId = generateEntryId();
        
        // å€Ÿæ–¹åˆ†å½•
        AccountingEntry debitEntry = new AccountingEntry();
        debitEntry.setEntryId(entryId + "_DR");
        debitEntry.setBusinessId(request.getBusinessId());
        debitEntry.setAccountNo(request.getAccountNo());
        debitEntry.setDirection(Direction.DEBIT);
        debitEntry.setAmount(request.getAmount().abs());
        debitEntry.setSubjectCode(getSubjectCode(request.getChangeType(), Direction.DEBIT));
        debitEntry.setBusinessType(request.getBusinessType());
        debitEntry.setRemark(request.getRemark());
        
        // è´·æ–¹åˆ†å½•
        AccountingEntry creditEntry = new AccountingEntry();
        creditEntry.setEntryId(entryId + "_CR");
        creditEntry.setBusinessId(request.getBusinessId());
        creditEntry.setAccountNo(request.getAccountNo());
        creditEntry.setDirection(Direction.CREDIT);
        creditEntry.setAmount(request.getAmount().abs());
        creditEntry.setSubjectCode(getSubjectCode(request.getChangeType(), Direction.CREDIT));
        creditEntry.setBusinessType(request.getBusinessType());
        creditEntry.setRemark(request.getRemark());
        
        // æ’å…¥åˆ†å½•
        entryMapper.insert(debitEntry);
        entryMapper.insert(creditEntry);
    }
}
```

### 3. æ”¯ä»˜å®‰å…¨ä¸é£æ§

#### é¢˜ç›®4ï¼šè®¾è®¡å®æ—¶é£æ§ç³»ç»Ÿ
**é—®é¢˜**ï¼šè®¾è®¡ä¸€ä¸ªå®æ—¶æ”¯ä»˜é£æ§ç³»ç»Ÿï¼Œè¦æ±‚æ¯«ç§’çº§å“åº”ï¼Œæ”¯æŒå¤æ‚è§„åˆ™å’Œæœºå™¨å­¦ä¹ æ¨¡å‹ã€‚

**é£æ§æ¶æ„è®¾è®¡**ï¼š
```java
@Service
@Slf4j
public class RiskControlService {
    
    @Autowired
    private RuleEngine ruleEngine;
    
    @Autowired
    private MLModelService mlModelService;
    
    @Autowired
    private RiskProfileService profileService;
    
    // å®æ—¶é£æ§æ£€æŸ¥
    public RiskCheckResult checkRisk(PaymentRequest request) {
        try {
            // 1. æ„å»ºé£æ§ä¸Šä¸‹æ–‡
            RiskContext context = buildRiskContext(request);
            
            // 2. è§„åˆ™å¼•æ“æ£€æŸ¥
            RuleCheckResult ruleResult = ruleEngine.evaluate(context);
            if (ruleResult.isBlocked()) {
                return RiskCheckResult.blocked(ruleResult.getReason());
            }
            
            // 3. æœºå™¨å­¦ä¹ æ¨¡å‹è¯„åˆ†
            MLModelResult modelResult = mlModelService.predict(context);
            if (modelResult.getRiskScore() > RISK_THRESHOLD) {
                return RiskCheckResult.review(modelResult.getReason());
            }
            
            // 4. å®æ—¶ç‰¹å¾æ›´æ–°
            updateRealTimeFeatures(context);
            
            return RiskCheckResult.pass();
            
        } catch (Exception e) {
            log.error("é£æ§æ£€æŸ¥å¼‚å¸¸: request={}", request, e);
            // é£æ§å¼‚å¸¸æ—¶çš„é™çº§ç­–ç•¥
            return RiskCheckResult.review("é£æ§æœåŠ¡å¼‚å¸¸");
        }
    }
    
    private RiskContext buildRiskContext(PaymentRequest request) {
        RiskContext context = new RiskContext();
        
        // åŸºç¡€ä¿¡æ¯
        context.setUserId(request.getUserId());
        context.setAmount(request.getAmount());
        context.setPaymentMethod(request.getPaymentMethod());
        context.setMerchantId(request.getMerchantId());
        
        // è®¾å¤‡ä¿¡æ¯
        DeviceInfo deviceInfo = deviceService.getDeviceInfo(request.getDeviceId());
        context.setDeviceInfo(deviceInfo);
        
        // ç”¨æˆ·ç”»åƒ
        UserRiskProfile userProfile = profileService.getUserProfile(request.getUserId());
        context.setUserProfile(userProfile);
        
        // å®æ—¶ç‰¹å¾
        RealTimeFeatures rtFeatures = featureService.getRealTimeFeatures(request.getUserId());
        context.setRealTimeFeatures(rtFeatures);
        
        return context;
    }
}

// è§„åˆ™å¼•æ“
@Component
public class RuleEngine {
    
    @Autowired
    private RuleRepository ruleRepository;
    
    private final DroolsContainer droolsContainer = new DroolsContainer();
    
    public RuleCheckResult evaluate(RiskContext context) {
        // è·å–é€‚ç”¨è§„åˆ™
        List<RiskRule> rules = ruleRepository.getActiveRules(context.getBusinessType());
        
        // æ‰§è¡Œè§„åˆ™
        for (RiskRule rule : rules) {
            RuleResult result = executeRule(rule, context);
            if (result.isTriggered()) {
                return RuleCheckResult.blocked(rule.getRuleName(), result.getReason());
            }
        }
        
        return RuleCheckResult.pass();
    }
    
    private RuleResult executeRule(RiskRule rule, RiskContext context) {
        switch (rule.getRuleType()) {
            case AMOUNT_LIMIT:
                return checkAmountLimit(rule, context);
                
            case FREQUENCY_LIMIT:
                return checkFrequencyLimit(rule, context);
                
            case DEVICE_ANOMALY:
                return checkDeviceAnomaly(rule, context);
                
            case BEHAVIOR_PATTERN:
                return checkBehaviorPattern(rule, context);
                
            default:
                return RuleResult.pass();
        }
    }
    
    // é‡‘é¢é™åˆ¶æ£€æŸ¥
    private RuleResult checkAmountLimit(RiskRule rule, RiskContext context) {
        BigDecimal maxAmount = new BigDecimal(rule.getThreshold());
        
        if (context.getAmount().compareTo(maxAmount) > 0) {
            return RuleResult.blocked("å•ç¬”é‡‘é¢è¶…é™: " + context.getAmount());
        }
        
        // æ£€æŸ¥æ—¥ç´¯è®¡é‡‘é¢
        BigDecimal dailyAmount = getDailyAmount(context.getUserId());
        if (dailyAmount.add(context.getAmount()).compareTo(maxAmount.multiply(new BigDecimal("10"))) > 0) {
            return RuleResult.blocked("æ—¥ç´¯è®¡é‡‘é¢è¶…é™");
        }
        
        return RuleResult.pass();
    }
    
    // é¢‘æ¬¡é™åˆ¶æ£€æŸ¥
    private RuleResult checkFrequencyLimit(RiskRule rule, RiskContext context) {
        int maxCount = Integer.parseInt(rule.getThreshold());
        int recentCount = getRecentPaymentCount(context.getUserId(), 1); // 1å°æ—¶å†…
        
        if (recentCount >= maxCount) {
            return RuleResult.blocked("æ”¯ä»˜é¢‘æ¬¡è¿‡é«˜: " + recentCount);
        }
        
        return RuleResult.pass();
    }
}
```

### 4. å¯¹è´¦ä¸æ¸…ç»“ç®—

#### é¢˜ç›®5ï¼šè®¾è®¡è‡ªåŠ¨åŒ–å¯¹è´¦ç³»ç»Ÿ
**é—®é¢˜**ï¼šè®¾è®¡ä¸€ä¸ªä¸é“¶è¡Œã€ç¬¬ä¸‰æ–¹æ”¯ä»˜æœºæ„çš„è‡ªåŠ¨åŒ–å¯¹è´¦ç³»ç»Ÿï¼Œè¦æ±‚å‡†ç¡®æ€§100%ã€‚

**å¯¹è´¦ç³»ç»Ÿæ¶æ„**ï¼š
```java
@Service
@Slf4j
public class ReconciliationService {
    
    @Autowired
    private PaymentOrderMapper orderMapper;
    
    @Autowired
    private ReconciliationRecordMapper reconciliationMapper;
    
    @Autowired
    private ChannelFileService fileService;
    
    // æ‰§è¡Œå¯¹è´¦
    @Scheduled(cron = "0 30 2 * * ?") // æ¯æ—¥2:30æ‰§è¡Œ
    public void executeReconciliation() {
        String date = DateUtils.format(DateUtils.addDays(new Date(), -1), "yyyyMMdd");
        
        // è·å–æ‰€æœ‰æ¸ é“
        List<PaymentChannel> channels = channelService.getAllChannels();
        
        for (PaymentChannel channel : channels) {
            try {
                executeChannelReconciliation(channel, date);
            } catch (Exception e) {
                log.error("æ¸ é“å¯¹è´¦å¤±è´¥: channel={}, date={}", channel.getChannelCode(), date, e);
                // å‘é€å‘Šè­¦
                alertService.sendAlert("å¯¹è´¦å¤±è´¥", channel.getChannelCode(), date);
            }
        }
    }
    
    private void executeChannelReconciliation(PaymentChannel channel, String date) {
        // 1. ä¸‹è½½æ¸ é“å¯¹è´¦æ–‡ä»¶
        ReconciliationFile channelFile = fileService.downloadFile(channel, date);
        if (channelFile == null) {
            log.warn("æ¸ é“å¯¹è´¦æ–‡ä»¶ä¸å­˜åœ¨: channel={}, date={}", channel.getChannelCode(), date);
            return;
        }
        
        // 2. è§£ææ¸ é“æ•°æ®
        List<ChannelRecord> channelRecords = parseChannelFile(channelFile);
        
        // 3. æŸ¥è¯¢ç³»ç»Ÿå†…éƒ¨æ•°æ®
        List<PaymentOrder> systemOrders = orderMapper.selectByChannelAndDate(
            channel.getChannelCode(), date);
        
        // 4. æ‰§è¡Œå¯¹è´¦é€»è¾‘
        ReconciliationResult result = doReconciliation(channelRecords, systemOrders);
        
        // 5. ä¿å­˜å¯¹è´¦ç»“æœ
        saveReconciliationResult(channel, date, result);
        
        // 6. å¤„ç†å·®å¼‚è®¢å•
        handleDiscrepancies(result.getDiscrepancies());
    }
    
    private ReconciliationResult doReconciliation(List<ChannelRecord> channelRecords,
                                                List<PaymentOrder> systemOrders) {
        
        ReconciliationResult result = new ReconciliationResult();
        
        // è½¬æ¢ä¸ºMapä¾¿äºæŸ¥æ‰¾
        Map<String, ChannelRecord> channelMap = channelRecords.stream()
            .collect(Collectors.toMap(ChannelRecord::getOrderId, r -> r));
        
        Map<String, PaymentOrder> systemMap = systemOrders.stream()
            .collect(Collectors.toMap(PaymentOrder::getChannelOrderId, o -> o));
        
        // æŸ¥æ‰¾åŒ¹é…ã€å·®å¼‚è®¢å•
        Set<String> allOrderIds = new HashSet<>();
        allOrderIds.addAll(channelMap.keySet());
        allOrderIds.addAll(systemMap.keySet());
        
        for (String orderId : allOrderIds) {
            ChannelRecord channelRecord = channelMap.get(orderId);
            PaymentOrder systemOrder = systemMap.get(orderId);
            
            if (channelRecord != null && systemOrder != null) {
                // åŒè¾¹éƒ½æœ‰ï¼Œæ£€æŸ¥ä¸€è‡´æ€§
                if (isMatched(channelRecord, systemOrder)) {
                    result.addMatched(orderId);
                } else {
                    result.addDiscrepancy(orderId, "é‡‘é¢æˆ–çŠ¶æ€ä¸ä¸€è‡´", channelRecord, systemOrder);
                }
            } else if (channelRecord != null) {
                // æ¸ é“æœ‰ï¼Œç³»ç»Ÿæ— 
                result.addDiscrepancy(orderId, "ç³»ç»Ÿç¼ºå¤±è®¢å•", channelRecord, null);
            } else {
                // ç³»ç»Ÿæœ‰ï¼Œæ¸ é“æ— 
                result.addDiscrepancy(orderId, "æ¸ é“ç¼ºå¤±è®¢å•", null, systemOrder);
            }
        }
        
        return result;
    }
    
    private boolean isMatched(ChannelRecord channelRecord, PaymentOrder systemOrder) {
        // æ£€æŸ¥é‡‘é¢
        if (channelRecord.getAmount().compareTo(systemOrder.getAmount()) != 0) {
            return false;
        }
        
        // æ£€æŸ¥çŠ¶æ€
        if (!channelRecord.getStatus().equals(systemOrder.getChannelStatus())) {
            return false;
        }
        
        // æ£€æŸ¥æ—¶é—´ï¼ˆå…è®¸ä¸€å®šè¯¯å·®ï¼‰
        long timeDiff = Math.abs(channelRecord.getPayTime().getTime() - 
                                systemOrder.getFinishTime().getTime());
        if (timeDiff > 60 * 1000) { // 1åˆ†é’Ÿè¯¯å·®
            return false;
        }
        
        return true;
    }
    
    // å¤„ç†å·®å¼‚è®¢å•
    private void handleDiscrepancies(List<ReconciliationDiscrepancy> discrepancies) {
        for (ReconciliationDiscrepancy discrepancy : discrepancies) {
            switch (discrepancy.getType()) {
                case SYSTEM_MISSING:
                    handleSystemMissing(discrepancy);
                    break;
                    
                case CHANNEL_MISSING:
                    handleChannelMissing(discrepancy);
                    break;
                    
                case AMOUNT_MISMATCH:
                    handleAmountMismatch(discrepancy);
                    break;
                    
                case STATUS_MISMATCH:
                    handleStatusMismatch(discrepancy);
                    break;
            }
        }
    }
}
```

## ğŸ“Š é¢è¯•è¯„åˆ†æ ‡å‡†

### æ”¯ä»˜ä¸šåŠ¡ç†è§£ (30%)
- **ä¸šåŠ¡æµç¨‹**ï¼šå¯¹æ”¯ä»˜å®Œæ•´ä¸šåŠ¡æµç¨‹çš„ç†è§£
- **æ³•è§„åˆè§„**ï¼šæ”¯ä»˜è¡Œä¸šæ³•è§„å’Œåˆè§„è¦æ±‚
- **é£é™©è¯†åˆ«**ï¼šæ”¯ä»˜é£é™©ç‚¹è¯†åˆ«å’Œé˜²æ§
- **ç”¨æˆ·ä½“éªŒ**ï¼šæ”¯ä»˜ä½“éªŒä¼˜åŒ–å’Œå¼‚å¸¸å¤„ç†

### ç³»ç»Ÿæ¶æ„è®¾è®¡ (35%)
- **é«˜å¯ç”¨æ¶æ„**ï¼šæ”¯ä»˜ç³»ç»Ÿçš„é«˜å¯ç”¨è®¾è®¡
- **æ•°æ®ä¸€è‡´æ€§**ï¼šåˆ†å¸ƒå¼äº‹åŠ¡å’Œæ•°æ®ä¸€è‡´æ€§
- **æ€§èƒ½ä¼˜åŒ–**ï¼šé«˜å¹¶å‘åœºæ™¯ä¸‹çš„æ€§èƒ½ä¼˜åŒ–
- **å®‰å…¨è®¾è®¡**ï¼šæ”¯ä»˜å®‰å…¨å’Œé£æ§ä½“ç³»è®¾è®¡

### æŠ€æœ¯å®ç°èƒ½åŠ› (25%)
- **ç¼–ç¨‹èƒ½åŠ›**ï¼šä»£ç è´¨é‡å’Œè®¾è®¡æ¨¡å¼åº”ç”¨
- **æ•°æ®åº“è®¾è®¡**ï¼šè´¦åŠ¡æ¨¡å‹å’Œæ•°æ®åº“è®¾è®¡
- **ä¸­é—´ä»¶ä½¿ç”¨**ï¼šæ¶ˆæ¯é˜Ÿåˆ—ã€ç¼“å­˜ç­‰ä¸­é—´ä»¶
- **ç›‘æ§è¿ç»´**ï¼šç³»ç»Ÿç›‘æ§å’Œæ•…éšœå¤„ç†

### åˆ›æ–°æ€ç»´ (10%)
- **æŠ€æœ¯åˆ›æ–°**ï¼šæ–°æŠ€æœ¯åœ¨æ”¯ä»˜åœºæ™¯çš„åº”ç”¨
- **ä¸šåŠ¡åˆ›æ–°**ï¼šæ”¯ä»˜äº§å“å’Œæ¨¡å¼åˆ›æ–°
- **é—®é¢˜è§£å†³**ï¼šå¤æ‚é—®é¢˜çš„åˆ†æå’Œè§£å†³
- **æŒç»­æ”¹è¿›**ï¼šç³»ç»Ÿä¼˜åŒ–å’Œæ”¹è¿›æ€è·¯

## ğŸ¯ å¤‡è€ƒå»ºè®®

### ä¸šåŠ¡çŸ¥è¯†
1. **æ”¯ä»˜åŸºç¡€**ï¼šå­¦ä¹ æ”¯ä»˜è¡Œä¸šåŸºç¡€çŸ¥è¯†å’Œæœ¯è¯­
2. **ç›‘ç®¡æ³•è§„**ï¼šäº†è§£å¤®è¡Œæ”¯ä»˜ä¸šåŠ¡è§„èŒƒå’Œè¦æ±‚
3. **é£æ§çŸ¥è¯†**ï¼šå­¦ä¹ åæ¬ºè¯ˆå’Œé£é™©æ§åˆ¶ç†è®º
4. **ä¼šè®¡åŸºç¡€**ï¼šæŒæ¡åŸºæœ¬çš„ä¼šè®¡å’Œè´¢åŠ¡çŸ¥è¯†

### æŠ€æœ¯å®è·µ
1. **æ”¯ä»˜é¡¹ç›®**ï¼šå®Œæˆç«¯åˆ°ç«¯çš„æ”¯ä»˜ç³»ç»Ÿå¼€å‘
2. **åˆ†å¸ƒå¼äº‹åŠ¡**ï¼šæ·±å…¥ç†è§£åˆ†å¸ƒå¼äº‹åŠ¡å®ç°
3. **å®‰å…¨æŠ€æœ¯**ï¼šæŒæ¡åŠ å¯†ã€ç­¾åã€é˜²ç¯¡æ”¹æŠ€æœ¯
4. **æ€§èƒ½ä¼˜åŒ–**ï¼šæ”¯ä»˜åœºæ™¯ä¸‹çš„æ€§èƒ½ä¼˜åŒ–å®è·µ

### é˜¿é‡Œæ”¯ä»˜å­¦ä¹ 
- **æ”¯ä»˜å®æ¶æ„**ï¼šå­¦ä¹ æ”¯ä»˜å®æŠ€æœ¯æ¶æ„æ¼”è¿›
- **èš‚èšé‡‘æœæŠ€æœ¯**ï¼šäº†è§£èš‚èšé‡‘æœæŠ€æœ¯åˆ›æ–°
- **ç§»åŠ¨æ”¯ä»˜**ï¼šå­¦ä¹ ç§»åŠ¨æ”¯ä»˜æŠ€æœ¯å’Œå®‰å…¨
- **å›½é™…åŒ–æ”¯ä»˜**ï¼šäº†è§£è·¨å¢ƒæ”¯ä»˜æŠ€æœ¯æŒ‘æˆ˜

---
[â† è¿”å›é˜¿é‡Œå·´å·´é¢è¯•é¢˜åº“](./README.md) 